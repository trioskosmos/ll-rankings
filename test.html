<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>Master Rankings Suite</title>
    <style>
        :root {
            --bg: #22272e; --card: #2d333b; --border: #444c56;
            --pink: #f852ad; --green: #57ab5a; --red: #f85149;
            --text: #adbac7; --muted: #768390;
            --font-size-base: 22px;
        }

        * { box-sizing: border-box; }
        body { 
            font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); 
            margin: 0; font-size: var(--font-size-base); min-height: 100vh; display: flex; flex-direction: column; 
        }

        /* HEADER */
        header { background: var(--card); border-bottom: 2px solid var(--border); padding: 15px 20px; display: flex; flex-direction: column; gap: 15px; flex-shrink: 0; }
        @media (min-width: 1024px) { header { flex-direction: row; justify-content: space-between; padding: 15px 40px; align-items: center; } }

        .brand-section { display: flex; align-items: center; gap: 20px; flex-wrap: wrap; }
        .brand-section h1 { font-size: 22px; margin: 0; text-transform: uppercase; color: #fff; letter-spacing: 1px; }

        .selector-group { display: flex; gap: 10px; }
        .selector-wrapper { display: flex; align-items: center; gap: 8px; background: var(--bg); padding: 4px 12px; border-radius: 8px; border: 1px solid var(--border); }
        .selector-wrapper label { font-size: 9px; text-transform: uppercase; color: var(--muted); font-weight: bold; }
        select { background: transparent; color: #fff; border: none; font-size: 14px; font-weight: bold; cursor: pointer; outline: none; }

        .nav { display: flex; gap: 20px; overflow-x: auto; padding-bottom: 5px; }
        .nav-item { cursor: pointer; color: var(--muted); font-size: 13px; font-weight: bold; text-transform: uppercase; white-space: nowrap; padding: 5px 0; border-bottom: 3px solid transparent; }
        .nav-item.active { color: var(--pink); border-bottom-color: var(--pink); }

        /* MAIN CONTENT */
        main { flex: 1; padding: 20px; padding-bottom: 120px; overflow-y: auto; }
        @media (min-width: 1024px) { main { padding: 40px 40px 140px 40px; } }

        .grid { display: grid; grid-template-columns: 1fr; gap: 25px; }
        @media (min-width: 1200px) { .grid { grid-template-columns: repeat(2, 1fr); } }

        .card { background: var(--card); border: 2px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 25px; position: relative; }
        h3 { margin: 0 0 20px 0; color: #fff; font-size: 16px; text-transform: uppercase; letter-spacing: 2px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }

        .table-container { width: 100%; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 500px; }
        th { text-align: left; padding: 12px 8px; color: var(--muted); border-bottom: 2px solid var(--border); text-transform: uppercase; font-size: 11px; }
        td { padding: 12px 8px; border-bottom: 1px solid var(--border); font-size: 14px; }
        .metric { font-family: monospace; font-weight: bold; color: var(--pink); font-size: 16px; }

        /* FIXED FOOTER */
        footer { position: fixed; bottom: 0; left: 0; width: 100%; background: #1c2128; border-top: 2px solid var(--border); padding: 10px 20px; display: flex; align-items: center; justify-content: space-between; gap: 15px; z-index: 1000; }
        .footer-left { display: flex; align-items: center; gap: 15px; flex: 1; min-width: 0; }
        .btn-footer { background: var(--bg); color: var(--text); border: 1px solid var(--border); padding: 6px 14px; border-radius: 6px; font-size: 11px; cursor: pointer; font-weight: bold; white-space: nowrap; }
        .btn-submit-action { background: var(--pink); color: #000; border: none; }
        #engine-log { font-size: 11px; font-family: monospace; color: var(--muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* BARS */
        .bar-bg { width: 100%; height: 12px; background: #1c2128; margin-top: 8px; border-radius: 6px; overflow: hidden; }
        .bar-fill { height: 100%; background: var(--pink); border-radius: 6px; transition: width 0.6s ease; width: 0; }

        /* MODAL */
        #submission-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(13, 17, 23, 0.98); display: none; justify-content: center; align-items: center; z-index: 2000; padding: 20px; }
        .modal-card { width: 100%; max-width: 800px; background: var(--card); border: 2px solid var(--border); border-radius: 12px; padding: 30px; position: relative; max-height: 90vh; overflow-y: auto; }
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; color: var(--muted); }
        input[type="text"], textarea, .modal-select { width: 100%; background: #1c2128; border: 1px solid var(--border); border-radius: 8px; color: #fff; padding: 12px; font-size: 16px; outline: none; margin-top: 5px; }
        textarea { height: 250px; font-family: monospace; font-size: 14px; }
        .submit-btn { background: var(--pink); color: #000; font-weight: 800; border: none; padding: 15px; border-radius: 8px; width: 100%; cursor: pointer; text-transform: uppercase; font-size: 14px; margin-top: 20px; }

        /* MATRIX FIX */
        #c-matrix { display: grid; gap: 2px; margin-top: 10px; }
        .cell { aspect-ratio: 1/1; display: flex; align-items: center; justify-content: center; border-radius: 2px; font-size: 10px; font-weight: bold; border: 1px solid rgba(0,0,0,0.1); }
        .m-label { font-size: 9px; color: var(--muted); padding: 5px; text-align: center; font-weight: bold; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        .empty-notice { color: var(--muted); font-size: 12px; padding: 20px; text-align: center; font-style: italic; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<header>
    <div class="brand-section">
        <h1>Master Suite</h1>
        <div class="selector-group">
            <div class="selector-wrapper">
                <label>Franchise</label>
                <select id="view-franchise" onchange="changeFranchiseView()">
                    <option value="liella">Liella</option>
                    <option value="aqours">Aqours</option>
                    <option value="u's">u's</option>
                    <option value="nijigasaki">Nijigasaki</option>
                    <option value="hasunosora">Hasunosora</option>
                </select>
            </div>
            <div class="selector-wrapper">
                <label>View</label>
                <select id="view-subgroup" onchange="syncData()"></select>
            </div>
        </div>
    </div>
    <div class="nav">
        <div class="nav-item active" id="btn-leader" onclick="tab('leader')">Consensus</div>
        <div class="nav-item" id="btn-more" onclick="tab('more')">Analysis</div>
        <div class="nav-item" id="btn-opps" onclick="tab('opps')">Divergence</div>
        <div class="nav-item" id="btn-spice" onclick="tab('spice')">Spice Meter</div>
    </div>
</header>

<main>
    <div id="view-leader" class="card"><h3>Consensus Rankings Table</h3><div class="table-container" id="c-leaderboard"></div></div>
    <div id="view-more" class="grid hidden">
        <div class="card"><h3>Universally Top/Bottom 10</h3><div class="table-container" id="c-universal"></div></div>
        <div class="card"><h3>Most Disputed Songs</h3><div class="table-container" id="c-disputed"></div></div>
        <div class="card"><h3>Subunit Popularity</h3><div class="table-container" id="c-subunits"></div></div>
        <div class="card"><h3>Most Controversial Songs</h3><div class="table-container" id="c-controversy"></div></div>
        <div class="card"><h3>Sleeper Songs</h3><div class="table-container" id="c-sleeper"></div></div>
        <div class="card"><h3>Most Consistently Ranked</h3><div class="table-container" id="c-consistent"></div></div>
        <div class="card"><h3>Outlier Users</h3><div class="table-container" id="c-outliers"></div></div>
    </div>
    <div id="view-opps" class="card hidden"><h3>User Divergence Matrix</h3><div class="table-container" id="matrix-scroll-wrapper"><div id="c-matrix"></div></div></div>
    <div id="view-spice" class="card hidden"><h3>Weighted Global Spice Breakdown</h3><div id="c-spice"></div></div>
</main>

<div id="submission-overlay">
    <div class="modal-card">
        <span class="close-btn" onclick="toggleSubmission(false)">&times;</span>
        <h3>New Submission</h3>
        <div class="form-group"><label>Franchise</label><select id="sub-franchise" class="modal-select"><option value="liella">Liella</option><option value="aqours">Aqours</option><option value="u's">u's</option><option value="nijigasaki">Nijigasaki</option><option value="hasunosora">Hasunosora</option></select></div>
        <div class="form-group"><label>Username</label><input type="text" id="in-user" placeholder="Enter Name"></div>
        <div class="form-group"><label>Ranked List</label><textarea id="in-list" placeholder="1. Song - Artist"></textarea></div>
        <button class="submit-btn" onclick="postSubmission()">Submit to All Songs</button>
        <div id="submit-log" style="margin-top:15px; font-size:12px;"></div>
    </div>
</div>

<footer>
    <div class="footer-left"><div id="engine-log">READY</div></div>
    <div class="footer-right">
        <button class="btn-footer" onclick="recompute()">Recompute</button>
        <button class="btn-footer btn-submit-action" onclick="toggleSubmission(true)">Submit</button>
    </div>
</footer>

<script>
    const API = "http://localhost:8000/api/v1";
    let activeTab = 'leader', allSubgroups = []; 

    async function init() { await fetchMasterSubgroups(); syncData(); }

    async function fetchMasterSubgroups() {
        const franchises = ["liella", "aqours", "u's", "nijigasaki", "hasunosora"];
        const results = await Promise.all(franchises.map(f => fetch(`${API}/subgroups?franchise=${f}`).then(r => r.json()).catch(() => [])));
        allSubgroups = results.flat();
        updateSubgroupDropdown();
    }

    function updateSubgroupDropdown() {
        const f = document.getElementById('view-franchise').value, sel = document.getElementById("view-subgroup");
        const filtered = allSubgroups.filter(sg => sg.franchise === f);
        sel.innerHTML = filtered.map(s => `<option value="${s.name}">${s.name}</option>`).join("");
        if (filtered.some(s => s.name === "All Songs")) sel.value = "All Songs";
    }

    function changeFranchiseView() { 
        // 1. Wipe everything to prevent "Liella ghost data" from showing
        wipeUI();
        updateSubgroupDropdown(); 
        syncData(); 
    }

    function wipeUI() {
        const ids = ['c-leaderboard', 'c-universal', 'c-disputed', 'c-subunits', 'c-controversy', 'c-sleeper', 'c-consistent', 'c-outliers', 'c-matrix', 'c-spice'];
        ids.forEach(id => {
            const el = document.getElementById(id);
            if(el) el.innerHTML = `<div class="empty-notice">Updating for new franchise...</div>`;
        });
    }

    function tab(name) { 
        activeTab = name; 
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        document.getElementById(`btn-${name}`).classList.add('active');
        document.querySelectorAll('main > div').forEach(v => v.classList.add('hidden'));
        document.getElementById(`view-${name}`).classList.remove('hidden');
        syncData();
    }

    async function syncData() {
        const sub = document.getElementById('view-subgroup').value, f = document.getElementById('view-franchise').value;
        if (!sub) return;
        try {
            const [ranks, cont, takes, spice] = await Promise.all([
                fetch(`${API}/analysis/rankings?franchise=${f}&subgroup=${sub}`).then(r => r.ok ? r.json() : null),
                fetch(`${API}/analysis/controversy?franchise=${f}&subgroup=${sub}`).then(r => r.ok ? r.json() : null),
                fetch(`${API}/analysis/takes?franchise=${f}&subgroup=${sub}`).then(r => r.ok ? r.json() : null),
                fetch(`${API}/analysis/spice?franchise=${f}`).then(r => r.ok ? r.json() : null)
            ]);

            if (!ranks) { wipeUI(); return; }

            renderLeaderboard(ranks.rankings);
            if(activeTab === 'more') {
                renderUniversal(ranks.rankings, cont?.results || []); renderDisputed(takes?.takes || []);
                renderSubunitPopularity(ranks.rankings, cont?.results || [], f); renderControversy(cont?.results || []);
                renderConsistent(cont?.results || []); renderSleepers(takes?.takes || []); renderOutliers(spice?.results || []);
            }
            if(activeTab === 'opps') renderMatrix(sub, f);
            if(activeTab === 'spice') renderSpice(spice?.results || []);
        } catch (e) { wipeUI(); }
    }

    function renderLeaderboard(ranks) {
        document.getElementById('c-leaderboard').innerHTML = `<table><tr><th>Rank</th><th>Song Name</th><th>Avg Rank</th><th>Points</th></tr>` + 
            ranks.map((s, i) => `<tr><td style="font-weight:800; color:var(--pink)">${i+1}</td><td>${s.song_name}</td><td class="metric">${s.average}</td><td>${s.points}</td></tr>`).join('') + `</table>`;
    }

    function renderUniversal(ranks, controversy) {
        const top = ranks.slice(0, 10), btm = ranks.slice(-10);
        const mapAgreement = (songName) => {
            const c = controversy.find(x => x.song_name === songName);
            if (!c) return "0.0";
            return Math.max(0, 100 - ((c.cv * c.avg_rank) * 2.5)).toFixed(1);
        };
        const rows = [...top, ...btm].map((s, i) => `<tr><td><span style="color:${i < 10 ? 'var(--green)' : 'var(--red)'}; font-weight:bold;">${i < 10 ? 'TOP' : 'BTM'}</span></td><td>${s.song_name}</td><td class="metric">${s.average}</td><td>${mapAgreement(s.song_name)}%</td></tr>`).join('');
        document.getElementById('c-universal').innerHTML = `<table><tr><th>Type</th><th>Song Name</th><th>Avg Rank</th><th>Agreement</th></tr>${rows}</table>`;
    }

    function renderDisputed(takes) {
        const songGroups = {};
        takes.forEach(t => { if (!songGroups[t.song_name]) songGroups[t.song_name] = []; songGroups[t.song_name].push(t); });
        const res = Object.keys(songGroups).map(name => {
            const g = songGroups[name].sort((a,b) => a.user_rank - b.user_rank);
            return { name, fight: `${g[0].username} vs ${g[g.length-1].username}`, diff: Math.abs(g[g.length-1].user_rank - g[0].user_rank), avg: (g.reduce((a,c)=>a+Math.abs(c.delta),0)/g.length).toFixed(1) };
        }).sort((a,b) => b.diff - a.diff).slice(0, 10);
        document.getElementById('c-disputed').innerHTML = `<table><tr><th>Song Name</th><th>Biggest Fight</th><th>Max Diff</th><th>Avg Diff</th></tr>` + res.map(r => `<tr><td>${r.name}</td><td style="font-weight:bold">${r.fight}</td><td class="metric">${r.diff}</td><td>${r.avg}</td></tr>`).join('') + `</table>`;
    }

    function renderSubunitPopularity(rankings, controversy, franchise) {
        const subunits = allSubgroups.filter(sg => sg.franchise === franchise && sg.is_subunit);
        if (!subunits.length) { document.getElementById('c-subunits').innerHTML = "No units defined."; return; }
        const data = subunits.map(unit => {
            const rS = rankings.filter(r => unit.songs.includes(r.song_name)), cS = controversy.filter(r => unit.songs.includes(r.song_name));
            return { name: unit.name, avg: rS.length ? (rS.reduce((a,b)=>a+b.average,0)/rS.length).toFixed(2) : 0, div: cS.length ? (cS.reduce((a,b)=>a+b.cv,0)/cS.length).toFixed(4) : 0 };
        }).sort((a,b) => a.avg - b.avg);
        document.getElementById('c-subunits').innerHTML = `<table><tr><th>Unit</th><th>Avg Rank</th><th>Divergence</th></tr>` + data.map(d => `<tr><td style="font-weight:bold; color:#fff">${d.name}</td><td class="metric">${d.avg}</td><td>${d.div}</td></tr>`).join('') + `</table>`;
    }

    function renderControversy(results) { document.getElementById('c-controversy').innerHTML = `<table><tr><th>Song Name</th><th>Score</th><th>Divergence</th><th>Avg Rank</th></tr>` + results.slice(0, 10).map(s => `<tr><td>${s.song_name}</td><td class="metric">${s.controversy_score}</td><td>${s.cv}</td><td>${s.avg_rank}</td></tr>`).join('') + `</table>`; }
    function renderConsistent(results) { const sorted = [...results].sort((a,b) => a.controversy_score - b.controversy_score).slice(0, 10); document.getElementById('c-consistent').innerHTML = `<table><tr><th>Song Name</th><th>Score</th><th>Divergence</th><th>Avg Rank</th></tr>` + sorted.map(s => `<tr><td>${s.song_name}</td><td class="metric">${s.controversy_score}</td><td>${s.cv}</td><td>${s.avg_rank}</td></tr>`).join('') + `</table>`; }
    function renderSleepers(takes) { const sleepers = takes.filter(t => t.score < -15).slice(0, 10); document.getElementById('c-sleeper').innerHTML = `<table><tr><th>Song Name</th><th>Lover</th><th>Avg Rank</th><th>Gap</th></tr>` + sleepers.map(t => `<tr><td>${t.song_name}</td><td style="font-weight:bold">${t.username}</td><td>${t.group_avg}</td><td class="metric" style="color:var(--green)">${Math.abs(t.delta).toFixed(1)}</td></tr>`).join('') + `</table>`; }
    
    function renderOutliers(results) { 
        if (!results || !results.length) { document.getElementById('c-outliers').innerHTML = "No data."; return; }
        const s = results.map(u => u.global_spice), min = Math.min(...s), max = Math.max(...s), r = (max - min) || 1;
        document.getElementById('c-outliers').innerHTML = `<table><tr><th>Username</th><th>Spice</th><th>Heat</th></tr>` + 
            results.slice(0, 10).map(u => {
                const norm = ((u.global_spice - min) / r) * 100;
                return `<tr><td style="font-weight:bold">${u.username}</td><td class="metric">${u.global_spice}</td><td><div class="bar-bg"><div class="bar-fill" style="width:${norm}%"></div></div></td></tr>`;
            }).join('') + `</table>`;
    }

    async function renderMatrix(sub, f) {
        const wrap = document.getElementById("c-matrix");
        wrap.innerHTML = "Fetching matrix...";
        try {
            const r = await fetch(`${API}/analysis/divergence?franchise=${f}&subgroup=${sub}`);
            if (!r.ok) { wrap.innerHTML = "Insufficient data."; return; }
            const d = await r.json(), u = Object.keys(d.matrix).sort();
            if (u.length === 0) { wrap.innerHTML = "Insufficient data."; return; }
            const max = Math.max(...Object.values(d.matrix).flatMap(o => Object.values(o))) || 1;
            wrap.style.gridTemplateColumns = `120px repeat(${u.length}, 1fr)`;
            wrap.innerHTML = `<div></div>` + u.map(n => `<div class="m-label">${n}</div>`).join('');
            u.forEach(u1 => { wrap.innerHTML += `<div class="m-label" style="text-align:left">${u1}</div>`; u.forEach(u2 => { const v = d.matrix[u1][u2], op = Math.pow(v/max, 1.8); wrap.innerHTML += `<div class="cell" style="background:rgba(248, 82, 173, ${op}); color:${op > 0.5 ? '#000' : '#fff'}; border-bottom:1px solid #1c2128;">${v}</div>`; }); });
        } catch (e) { wrap.innerHTML = "Analysis not ready."; }
    }

    function renderSpice(results) {
        if (!results || !results.length) { document.getElementById('c-spice').innerHTML = `<div class="empty-notice">No spice data computed for this franchise.</div>`; return; }
        const s = results.map(u => u.global_spice), min = Math.min(...s), max = Math.max(...s), r = (max - min) || 1;
        document.getElementById('c-spice').innerHTML = results.map(u => {
            const norm = ((u.global_spice - min) / r) * 100;
            return `<div style="margin-bottom:40px;"><div style="display:flex; justify-content:space-between; font-size:20px;"><strong>${u.username}</strong><span class="metric">${u.global_spice}</span></div><div class="bar-bg" style="height:20px"><div class="bar-fill" style="width:${norm}%"></div></div><div style="font-size:12px; color:var(--muted); margin-top:15px; line-height:1.6">${Object.entries(u.group_breakdown).map(([k,v])=>`<strong>${k}</strong>: ${v}`).join(' â€¢ ')}</div></div>`;
        }).join('');
    }

    function toggleSubmission(show) { document.getElementById('submission-overlay').style.display = show ? 'flex' : 'none'; }
    async function postSubmission() {
        const log = document.getElementById('submit-log'), user = document.getElementById('in-user').value, list = document.getElementById('in-list').value, franchise = document.getElementById('sub-franchise').value;
        log.innerHTML = "POSTING...";
        try {
            const r = await fetch(`${API}/submit`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username: user, franchise: franchise, subgroup_name: "All Songs", ranking_list: list }) });
            const d = await r.json();
            if (d.status === "VALID") log.innerHTML = `<span style="color:var(--green)">SUCCESS. Trigger Recompute.</span>`;
            else log.innerHTML = `<span style="color:var(--red)">ERR: LINE ${Object.values(d.conflicts)[0].line_num}</span>`;
        } catch (e) { log.innerHTML = "ERROR."; }
    }

    async function recompute() {
        document.getElementById('engine-log').innerText = "CALCULATING...";
        await fetch(`${API}/analysis/trigger`, { method: 'POST' });
        setTimeout(() => { syncData(); document.getElementById('engine-log').innerText = "READY"; }, 3000);
    }

    init();
</script>
</body>
</html>