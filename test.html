<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liella Master Rankings Suite</title>
    <style>
        :root {
            --bg: #22272e; 
            --card: #2d333b; 
            --border: #444c56;
            --pink: #f852ad; 
            --green: #57ab5a; 
            --red: #f85149;
            --text: #adbac7; 
            --muted: #768390;
            --font-size-base: 20px;
        }

        * { box-sizing: border-box; }

        body { 
            font-family: -apple-system, system-ui, sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            margin: 0; 
            font-size: var(--font-size-base);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* RESPONSIVE HEADER */
        header {
            background: var(--card);
            border-bottom: 2px solid var(--border);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        @media (min-width: 1024px) {
            header { flex-direction: row; justify-content: space-between; padding: 20px 40px; }
        }

        .brand-section { display: flex; flex-direction: column; gap: 15px; }
        @media (min-width: 600px) { .brand-section { flex-direction: row; align-items: center; gap: 30px; } }

        .brand-section h1 { font-size: 28px; margin: 0; text-transform: uppercase; color: #fff; letter-spacing: 2px; }

        .subgroup-wrapper { 
            display: flex; align-items: center; gap: 10px; background: var(--bg); 
            padding: 8px 15px; border-radius: 12px; border: 2px solid var(--border); 
            width: fit-content;
        }
        .subgroup-wrapper label { font-size: 12px; text-transform: uppercase; color: var(--muted); font-weight: bold; }
        select { background: transparent; color: #fff; border: none; font-size: 18px; font-weight: bold; cursor: pointer; outline: none; }

        /* SCROLLABLE NAV FOR MOBILE */
        .nav { 
            display: flex; gap: 25px; overflow-x: auto; white-space: nowrap; 
            padding-bottom: 5px; -webkit-overflow-scrolling: touch;
        }
        @media (min-width: 1024px) { .nav { gap: 40px; overflow: hidden; } }

        .nav-item { cursor: pointer; color: var(--muted); font-size: 16px; font-weight: bold; text-transform: uppercase; padding: 8px 0; border-bottom: 4px solid transparent; }
        .nav-item.active { color: var(--pink); border-bottom-color: var(--pink); }

        /* MAIN LAYOUT */
        main { flex: 1; overflow-y: auto; padding: 20px; }
        @media (min-width: 1024px) { main { padding: 40px; } }

        .grid { display: grid; grid-template-columns: 1fr; gap: 30px; }
        @media (min-width: 1100px) { .grid { grid-template-columns: repeat(2, 1fr); } }

        .card { 
            background: var(--card); border: 2px solid var(--border); 
            border-radius: 16px; padding: 20px; margin-bottom: 30px;
            overflow-x: auto;
        }
        @media (min-width: 1024px) { .card { padding: 40px; } }

        h3 { margin-top: 0; color: #fff; font-size: 18px; text-transform: uppercase; letter-spacing: 2px; border-bottom: 2px solid var(--border); padding-bottom: 15px; margin-bottom: 25px; }

        /* TABLES */
        .table-container { width: 100%; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 500px; }
        th { text-align: left; padding: 15px 10px; color: var(--muted); border-bottom: 2px solid var(--border); text-transform: uppercase; font-size: 12px; }
        td { padding: 15px 10px; border-bottom: 1px solid var(--border); font-size: 16px; }
        .metric { font-family: monospace; font-weight: bold; color: var(--pink); font-size: 20px; }

        /* MATRIX SPECIFIC */
        .matrix-wrapper { display: grid; gap: 4px; min-width: 800px; }
        .cell { aspect-ratio: 1/1; display: flex; align-items: center; justify-content: center; border-radius: 4px; font-size: 12px; font-weight: bold; }

        /* VISUALS */
        .bar-bg { height: 12px; background: #1c2128; margin-top: 8px; border-radius: 6px; }
        .bar-fill { height: 100%; background: var(--pink); border-radius: 6px; transition: width 0.4s ease; }
        
        .gap-visual { display: flex; align-items: center; height: 16px; width: 120px; background: #1c2128; border-radius: 8px; position: relative; }
        @media (min-width: 600px) { .gap-visual { width: 200px; } }
        .gap-dot { position: absolute; height: 10px; width: 10px; border-radius: 50%; }

        /* FOOTER */
        footer { background: #1c2128; border-top: 2px solid var(--border); padding: 15px 20px; display: flex; flex-direction: column; gap: 15px; align-items: center; }
        @media (min-width: 1024px) { footer { flex-direction: row; padding: 15px 40px; gap: 40px; } }
        
        .btn-sm { background: var(--bg); color: var(--text); border: 2px solid var(--border); padding: 12px 24px; border-radius: 8px; font-size: 14px; cursor: pointer; font-weight: bold; width: 100%; }
        @media (min-width: 1024px) { .btn-sm { width: auto; } }
        
        #engine-log { font-size: 12px; font-family: monospace; color: var(--muted); text-align: center; }

        .hidden { display: none; }
    </style>
</head>
<body>

<header>
    <div class="brand-section">
        <h1>Liella Master</h1>
        <div class="subgroup-wrapper">
            <label>Subgroup</label>
            <select id="sub-select" onchange="syncData()"></select>
        </div>
    </div>

    <div class="nav">
        <div class="nav-item active" id="btn-leader" onclick="tab('leader')">Consensus</div>
        <div class="nav-item" id="btn-more" onclick="tab('more')">Analysis</div>
        <div class="nav-item" id="btn-opps" onclick="tab('opps')">Divergence</div>
        <div class="nav-item" id="btn-spice" onclick="tab('spice')">Spice Meter</div>
    </div>
</header>

<main>
    <div id="view-leader" class="card">
        <h3>Community Rankings</h3>
        <div class="table-container" id="c-leaderboard"></div>
    </div>

    <div id="view-more" class="grid hidden">
        <div class="card">
            <h3>Universally Top/Bottom 10</h3>
            <div class="table-container" id="c-universal"></div>
        </div>
        <div class="card">
            <h3>Most Disputed Songs</h3>
            <div class="table-container" id="c-disputed"></div>
        </div>
        <div class="card">
            <h3>Subunit Popularity</h3>
            <div class="table-container" id="c-subunits"></div>
        </div>
        <div class="card">
            <h3>Most Controversial Songs</h3>
            <div class="table-container" id="c-controversy"></div>
        </div>
        <div class="card">
            <h3>Sleeper Songs</h3>
            <div class="table-container" id="c-sleeper"></div>
        </div>
        <div class="card">
            <h3>Most Consistently Ranked</h3>
            <div class="table-container" id="c-consistent"></div>
        </div>
        <div class="card">
            <h3>Outlier Users</h3>
            <div class="table-container" id="c-outliers"></div>
        </div>
    </div>

    <div id="view-opps" class="card hidden">
        <h3>User-to-User Divergence Matrix</h3>
        <div id="c-matrix" class="matrix-wrapper"></div>
    </div>

    <div id="view-spice" class="card hidden">
        <h3>Weighted Global Spice</h3>
        <div id="c-spice"></div>
    </div>
</main>

<footer>
    <button class="btn-sm" onclick="recompute()">Trigger Recompute</button>
    <div id="engine-log">READY...</div>
</footer>

<script>
    const API = "http://localhost:8000/api/v1";
    let activeTab = 'leader';

    async function init() {
        const d = await fetch(`${API}/health/database`).then(r => r.json());
        const sel = document.getElementById("sub-select");
        sel.innerHTML = d.subgroups_detail.map(s => `<option value="${s.name}">${s.name}</option>`).join("");
        sel.value = "All Songs";
        syncData();
    }

    function tab(name) {
        activeTab = name;
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        document.getElementById(`btn-${name}`).classList.add('active');
        document.querySelectorAll('main > div').forEach(v => v.classList.add('hidden'));
        document.getElementById(`view-${name}`).classList.remove('hidden');
        syncData();
    }

    async function syncData() {
        const sub = document.getElementById('sub-select').value;
        const [ranks, cont, takes, spice, subunits] = await Promise.all([
            fetch(`${API}/analysis/rankings?franchise=liella&subgroup=${sub}`).then(r => r.json()),
            fetch(`${API}/analysis/controversy?franchise=liella&subgroup=${sub}`).then(r => r.json()),
            fetch(`${API}/analysis/takes?franchise=liella&subgroup=${sub}`).then(r => r.json()),
            fetch(`${API}/analysis/spice?franchise=liella`).then(r => r.json()),
            fetch(`${API}/analysis/subgroups?franchise=liella`).then(r => r.json())
        ]);

        if(activeTab === 'leader') renderLeaderboard(ranks.rankings);
        if(activeTab === 'more') {
            renderUniversal(ranks.rankings, cont.results);
            renderDisputed(takes.takes);
            renderControversy(cont.results);
            renderConsistent(cont.results);
            renderSleepers(takes.takes);
            renderSubunitPopularity(ranks.rankings, cont.results, subunits.results);
            renderOutliers(spice.results);
        }
        if(activeTab === 'opps') renderMatrix(sub);
        if(activeTab === 'spice') renderSpice(spice.results);
    }

    function renderLeaderboard(ranks) {
        document.getElementById('c-leaderboard').innerHTML = `<table><tr><th>Rank</th><th>Song Name</th><th>Avg Rank</th><th>Total Points</th></tr>` + 
            ranks.map((s, i) => `<tr><td style="font-weight:800; color:var(--pink)">${i+1}</td><td>${s.song_name}</td><td class="metric">${s.average}</td><td>${s.points}</td></tr>`).join('') + `</table>`;
    }

    function renderUniversal(ranks, controversy) {
        const top = ranks.slice(0, 10), btm = ranks.slice(-10);
        const mapAgreement = (songName) => {
            const c = controversy.find(x => x.song_name === songName);
            return c ? Math.max(0, 100 - ((c.cv * c.avg_rank) * 2.5)).toFixed(1) : "0.0";
        };
        const rows = [...top, ...btm].map((s, i) => `<tr><td><span style="color:${i < 10 ? 'var(--green)' : 'var(--red)'}; font-weight:bold;">${i < 10 ? 'TOP' : 'BTM'}</span></td><td>${s.song_name}</td><td class="metric">${s.average}</td><td>${mapAgreement(s.song_name)}%</td></tr>`).join('');
        document.getElementById('c-universal').innerHTML = `<table><tr><th>Type</th><th>Song Name</th><th>Avg Rank</th><th>Agreement</th></tr>${rows}</table>`;
    }

    function renderDisputed(takes) {
        const songGroups = {};
        takes.forEach(t => { if (!songGroups[t.song_name]) songGroups[t.song_name] = []; songGroups[t.song_name].push(t); });
        const res = Object.keys(songGroups).map(name => {
            const g = songGroups[name].sort((a,b) => a.user_rank - b.user_rank);
            return { name, fight: `${g[0].username} vs ${g[g.length-1].username}`, diff: Math.abs(g[g.length-1].user_rank - g[0].user_rank), avg: (g.reduce((a,c)=>a+Math.abs(c.delta),0)/g.length).toFixed(1) };
        }).sort((a,b) => b.diff - a.diff).slice(0, 10);
        document.getElementById('c-disputed').innerHTML = `<table><tr><th>Song Name</th><th>Biggest Fight</th><th>Max Diff</th><th>Avg Diff</th></tr>` + res.map(r => `<tr><td>${r.name}</td><td style="font-weight:bold">${r.fight}</td><td class="metric">${r.diff}</td><td>${r.avg}</td></tr>`).join('') + `</table>`;
    }

    function renderControversy(results) {
        document.getElementById('c-controversy').innerHTML = `<table><tr><th>Song Name</th><th>Score</th><th>Divergence</th><th>Avg Rank</th></tr>` + results.slice(0, 10).map(s => `<tr><td>${s.song_name}</td><td class="metric">${s.controversy_score}</td><td>${s.cv}</td><td>${s.avg_rank}</td></tr>`).join('') + `</table>`;
    }

    function renderConsistent(results) {
        const sorted = [...results].sort((a,b) => a.controversy_score - b.controversy_score).slice(0, 10);
        document.getElementById('c-consistent').innerHTML = `<table><tr><th>Song Name</th><th>Score</th><th>Divergence</th><th>Avg Rank</th></tr>` + sorted.map(s => `<tr><td>${s.song_name}</td><td class="metric">${s.controversy_score}</td><td>${s.cv}</td><td>${s.avg_rank}</td></tr>`).join('') + `</table>`;
    }

    function renderSleepers(takes) {
        const sleepers = takes.filter(t => t.score < -15).slice(0, 10);
        document.getElementById('c-sleeper').innerHTML = `<table><tr><th>Song Name</th><th>Lover</th><th>Avg Rank</th><th>Gap</th></tr>` + sleepers.map(t => `<tr><td>${t.song_name}</td><td style="font-weight:bold">${t.username}</td><td>${t.group_avg}</td><td class="metric" style="color:var(--green)">${Math.abs(t.delta).toFixed(1)}</td></tr>`).join('') + `</table>`;
    }

    function renderSubunitPopularity(rankings, controversy, subunits) {
        const data = Object.entries(subunits).map(([name, songs]) => {
            const rS = rankings.filter(r => songs.includes(r.song_name)), cS = controversy.filter(r => songs.includes(r.song_name));
            return { name, avg: rS.length ? (rS.reduce((a,b)=>a+b.average,0)/rS.length).toFixed(2) : 0, div: cS.length ? (cS.reduce((a,b)=>a+b.cv,0)/cS.length).toFixed(4) : 0 };
        }).sort((a,b) => a.avg - b.avg);
        document.getElementById('c-subunits').innerHTML = `<table><tr><th>Unit Name</th><th>Avg Rank</th><th>Divergence</th></tr>` + data.map(d => `<tr><td style="font-weight:bold; color:#fff">${d.name}</td><td class="metric">${d.avg}</td><td>${d.div}</td></tr>`).join('') + `</table>`;
    }

    function renderOutliers(results) {
        if (!results.length) return;
        const s = results.map(u => u.global_spice), min = Math.min(...s), max = Math.max(...s), r = max - min || 1;
        document.getElementById('c-outliers').innerHTML = `<table><tr><th>Username</th><th>Spice</th><th>Heat</th></tr>` + results.slice(0, 10).map(u => `<tr><td style="font-weight:bold">${u.username}</td><td class="metric">${u.global_spice}</td><td><div class="bar-bg"><div class="bar-fill" style="width:${((u.global_spice-min)/r)*100}%"></div></div></td></tr>`).join('') + `</table>`;
    }

    async function renderMatrix(sub) {
        const d = await fetch(`${API}/analysis/divergence?franchise=liella&subgroup=${sub}`).then(r => r.json());
        const users = Object.keys(d.matrix).sort();
        const wrapper = document.getElementById("c-matrix");
        const max = Math.max(...Object.values(d.matrix).flatMap(o => Object.values(o))) || 1;
        wrapper.style.gridTemplateColumns = `140px repeat(${users.length}, 1fr)`;
        wrapper.innerHTML = `<div></div>` + users.map(u => `<div style="text-align:center; font-size:10px; font-weight:bold; padding:10px;">${u}</div>`).join('');
        users.forEach(u1 => {
            wrapper.innerHTML += `<div style="padding:15px; font-weight:bold; border-bottom:2px solid var(--border); font-size:12px;">${u1}</div>`;
            users.forEach(u2 => {
                const v = d.matrix[u1][u2], op = Math.pow(v/max, 1.8);
                wrapper.innerHTML += `<div class="cell" style="background:rgba(248, 82, 173, ${op}); color:${op > 0.5 ? '#000' : '#fff'}; border-bottom:1px solid #1c2128;">${v}</div>`;
            });
        });
    }

    function renderSpice(results) {
        if (!results.length) return;
        const s = results.map(u => u.global_spice), min = Math.min(...s), max = Math.max(...s), r = max - min || 1;
        document.getElementById('c-spice').innerHTML = results.map(u => {
            const norm = ((u.global_spice-min)/r)*100;
            return `<div style="margin-bottom:50px;"><div style="display:flex; justify-content:space-between; font-size:20px;"><strong>${u.username}</strong><span class="metric">GLOBAL HEAT: ${u.global_spice}</span></div><div class="bar-bg" style="height:20px"><div class="bar-fill" style="width:${norm}%"></div></div><div style="font-size:14px; color:var(--muted); margin-top:15px; background:#1c2128; padding:15px; border-radius:8px; border:2px solid var(--border); line-height:1.8">${Object.entries(u.group_breakdown).map(([k,v])=>`<strong>${k}</strong>: ${v}`).join(' â€¢ ')}</div></div>`;
        }).join('');
    }

    async function recompute() {
        document.getElementById('engine-log').innerText = "CALCULATING...";
        await fetch(`${API}/analysis/trigger`, { method: 'POST' });
        setTimeout(() => { syncData(); document.getElementById('engine-log').innerText = "DONE."; }, 4000);
    }

    init();
</script>
</body>
</html>