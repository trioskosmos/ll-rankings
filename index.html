<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Master Rankings Suite</title>
    <style>
        :root {
            /* Premium Dark Theme */
            --bg: #0d1117;
            --card: #161b22;
            --border: #30363d;
            --pink: #db61a2;
            /* Softer premium pink */
            --green: #3fb950;
            --red: #f85149;
            --yellow: #d29922;
            --purple: #a371f7;
            --text: #c9d1d9;
            --muted: #8b949e;
            --font-size-base: 16px;
            /* Reset to standard accessible size */
        }

        /* ... Reset ... */

        body {
            font-family: 'Segoe UI', -apple-system, sans-serif;
            /* Cleaner font stack */
            background: var(--bg);
            color: var(--text);
            margin: 0;
            font-size: var(--font-size-base);
            min-height: 100vh;
            overflow-x: hidden;
            letter-spacing: 0.02em;
        }

        /* --- CONTROLS & HEADER --- */
        select {
            background: #21262d;
            /* Distinct background */
            color: #fff;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
        }

        /* Fix for invisible text in some browsers */
        option {
            background: var(--bg);
            color: var(--text);
        }

        /* --- LAYOUT --- */
        * {
            box-sizing: border-box;
        }

        header {
            background: var(--card);
            border-bottom: 1px solid var(--border);
            padding: 15px 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        h1 {
            font-size: 18px;
            margin: 0;
            color: #fff;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .selector-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .selector-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg);
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--border);
        }

        .selector-wrapper label {
            font-size: 9px;
            text-transform: uppercase;
            color: var(--muted);
            font-weight: 700;
            letter-spacing: 1px;
        }

        .nav {
            display: flex;
            gap: 8px;
            margin-left: auto;
            flex-wrap: wrap;
        }

        .nav-item {
            cursor: pointer;
            color: var(--muted);
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            padding: 8px 14px;
            border-radius: 6px;
            background: transparent;
            border: 1px solid transparent;
            transition: all 0.2s ease;
        }

        .nav-item:hover {
            color: var(--text);
            background: rgba(255, 255, 255, 0.05);
        }

        .nav-item.active {
            color: var(--pink);
            background: rgba(219, 97, 162, 0.1);
            border-color: var(--pink);
        }

        /* --- MAIN CONTENT --- */
        main {
            padding: 25px;
            padding-bottom: 100px;
            max-width: 1800px;
            margin: 0 auto;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
        }

        @media (min-width: 1200px) {
            .grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            transition: border-color 0.2s ease;
        }

        .card:hover {
            border-color: #444c56;
        }

        h3 {
            margin: 0 0 15px 0;
            color: #fff;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }

        /* --- TABLES --- */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 10px 8px;
            color: var(--muted);
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid var(--border);
        }

        td {
            padding: 12px 8px;
            border-bottom: 1px solid rgba(48, 54, 61, 0.5);
            font-size: 14px;
            vertical-align: middle;
        }

        tr:hover td {
            background: rgba(255, 255, 255, 0.02);
        }

        .col-rank {
            width: 50px;
            font-weight: 800;
            color: var(--pink);
            font-family: 'Consolas', monospace;
        }

        .col-metric {
            width: 80px;
            text-align: right;
            font-family: 'Consolas', monospace;
            font-weight: 600;
        }

        .col-fight {
            width: 160px;
            font-size: 11px;
            color: var(--muted);
            font-style: italic;
        }

        /* --- MATRIX --- */
        #matrix-scroll-wrapper {
            overflow-x: auto;
        }

        #c-matrix {
            display: grid;
            gap: 2px;
            margin-top: 10px;
            width: fit-content;
        }

        .cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 700;
            min-width: 50px;
        }

        .m-label {
            font-size: 10px;
            color: var(--muted);
            padding: 8px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* --- FOOTER --- */
        footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--card);
            border-top: 1px solid var(--border);
            padding: 12px 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 100;
        }

        .footer-right {
            display: flex;
            gap: 10px;
        }

        .btn-footer {
            background: var(--bg);
            color: var(--text);
            border: 1px solid var(--border);
            padding: 10px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-footer:hover {
            background: var(--border);
        }

        .btn-submit-action {
            background: var(--pink);
            color: #000;
            border: none;
        }

        .btn-submit-action:hover {
            background: #e54d93;
        }

        #engine-log {
            font-size: 11px;
            font-family: 'Consolas', monospace;
            color: var(--muted);
        }

        /* --- VISUALS --- */
        .bar-bg {
            height: 18px;
            background: #21262d;
            border-radius: 4px;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--pink) 0%, var(--purple) 100%);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* --- DASHBOARD GRID --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 18px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 18px;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 140px;
            transition: all 0.2s ease;
        }

        .stat-card:hover {
            border-color: var(--pink);
            transform: translateY(-2px);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 3px;
            height: 100%;
            background: var(--pink);
        }

        .stat-label {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--muted);
            letter-spacing: 1px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 800;
            color: #fff;
            line-height: 1.2;
            margin-bottom: 4px;
        }

        .stat-sub {
            font-size: 13px;
            color: var(--pink);
            font-weight: 600;
            margin-top: auto;
        }

        /* --- SUBMISSION PAGE DESIGN --- */
        #submission-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(13, 17, 23, 0.98);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
        }

        .modal-card {
            width: 100%;
            max-width: 900px;
            background: var(--card);
            border: 2px solid var(--border);
            border-radius: 20px;
            padding: 45px;
            position: relative;
            max-height: 95vh;
            overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }

        .close-btn {
            position: absolute;
            top: 25px;
            right: 25px;
            font-size: 36px;
            cursor: pointer;
            color: var(--muted);
            line-height: 1;
            transition: color 0.2s;
        }

        .close-btn:hover {
            color: var(--pink);
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 12px;
            font-size: 14px;
            font-weight: 800;
            color: var(--text);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .modal-select {
            width: 100%;
            background: #1c2128;
            border: 2px solid var(--pink);
            border-radius: 12px;
            color: #fff;
            padding: 18px;
            font-size: 22px;
            font-weight: bold;
            outline: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 20px center;
            background-size: 20px;
        }

        .modal-input,
        .modal-textarea {
            width: 100%;
            background: #1c2128;
            border: 2px solid var(--border);
            border-radius: 12px;
            color: #fff;
            padding: 18px;
            font-size: 20px;
            outline: none;
            transition: border-color 0.2s;
        }

        .modal-input:focus,
        .modal-textarea:focus {
            border-color: var(--pink);
            box-shadow: 0 0 10px rgba(248, 82, 173, 0.2);
        }

        .modal-textarea {
            height: 350px;
            font-family: monospace;
            font-size: 16px;
            line-height: 1.5;
        }

        .submit-btn {
            background: var(--pink);
            color: #000;
            font-weight: 900;
            border: none;
            padding: 22px;
            border-radius: 12px;
            width: 100%;
            cursor: pointer;
            text-transform: uppercase;
            font-size: 20px;
            letter-spacing: 1px;
            transition: transform 0.1s, opacity 0.2s;
        }

        .submit-btn:active {
            transform: scale(0.98);
        }

        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* --- USERS PAGE STYLES --- */
        .user-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 20px;
        }

        .user-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .user-card:hover {
            border-color: var(--pink);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .user-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 20px;
            background: linear-gradient(135deg, rgba(219, 97, 162, 0.1) 0%, transparent 100%);
            border-bottom: 1px solid var(--border);
        }

        .user-name {
            font-size: 18px;
            font-weight: 800;
            color: var(--pink);
        }

        .song-count {
            font-size: 12px;
            color: var(--muted);
            font-family: monospace;
            background: var(--bg);
            padding: 4px 10px;
            border-radius: 20px;
        }

        .user-insights {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1px;
            background: var(--border);
            margin-bottom: 1px;
        }

        .insight-item {
            background: var(--card);
            padding: 12px 15px;
            font-size: 12px;
        }

        .insight-label {
            color: var(--muted);
            text-transform: uppercase;
            font-size: 9px;
            letter-spacing: 1px;
            margin-bottom: 3px;
        }

        .insight-value {
            color: #fff;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .insight-value.green {
            color: var(--green);
        }

        .insight-value.yellow {
            color: var(--yellow);
        }

        .rankings-list {
            max-height: 400px;
            overflow-y: auto;
            padding: 15px;
        }

        .rankings-list::-webkit-scrollbar {
            width: 6px;
        }

        .rankings-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .rankings-list::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        .rankings-list::-webkit-scrollbar-thumb:hover {
            background: var(--pink);
        }

        .rank-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 10px;
            margin-bottom: 4px;
            background: var(--bg);
            border-radius: 6px;
            transition: all 0.15s ease;
        }

        .rank-item:hover {
            background: #21262d;
            padding-left: 14px;
        }

        .rank-item.top-3 {
            background: linear-gradient(90deg, rgba(219, 97, 162, 0.15) 0%, var(--bg) 100%);
        }

        .rank-number {
            font-size: 14px;
            font-weight: 800;
            color: var(--pink);
            min-width: 35px;
            text-align: right;
            font-family: 'Consolas', monospace;
        }

        .rank-number.gold {
            color: #ffd700;
        }

        .rank-number.silver {
            color: #c0c0c0;
        }

        .rank-number.bronze {
            color: #cd7f32;
        }

        .song-name {
            flex: 1;
            font-size: 13px;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>

<body>

    <header>
        <div class="header-left">
            <h1>Rankings Suite</h1>
            <div class="selector-group">
                <div class="selector-wrapper">
                    <label>Franchise</label>
                    <select id="view-franchise" onchange="changeFranchiseView()">
                        <option value="liella">Liella</option>
                        <option value="aqours">Aqours</option>
                        <option value="u's">u's</option>
                        <option value="nijigasaki">Nijigasaki</option>
                        <option value="hasunosora">Hasunosora</option>
                    </select>
                </div>
                <div class="selector-wrapper">
                    <label>View</label>
                    <select id="view-subgroup" onchange="changeSubgroupView()"></select>
                </div>
            </div>
        </div>
        <div class="nav">
            <div class="nav-item active" id="btn-dash" onclick="tab('dash')">Dashboard</div>
            <div class="nav-item" id="btn-leader" onclick="tab('leader')">Rankings</div>
            <div class="nav-item" id="btn-more" onclick="tab('more')">Analysis</div>
            <div class="nav-item" id="btn-opps" onclick="tab('opps')">Divergence</div>
            <div class="nav-item" id="btn-rivals" onclick="tab('rivals')">Rivals</div>
            <div class="nav-item" id="btn-spice" onclick="tab('spice')">Spice</div>
            <div class="nav-item" id="btn-users" onclick="tab('users')">Users</div>
        </div>
    </header>

    <main>
        <!-- DASHBOARD VIEW -->
        <div id="view-dash" class="grid">
            <div class="dashboard-grid" id="dashboard-stats">
                <div class="stat-card">
                    <div class="stat-label">üëë Current #1</div>
                    <div class="stat-value" id="d-top-song">Loading...</div>
                    <div class="stat-sub" id="d-top-score">-- avg rank</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üî• Most Controversial</div>
                    <div class="stat-value" id="d-cont-song">Loading...</div>
                    <div class="stat-sub" id="d-cont-score">High Disagreement</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üå∂Ô∏è Spiciest User</div>
                    <div class="stat-value" id="d-spice-user">Loading...</div>
                    <div class="stat-sub" id="d-spice-val">-- Spice</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üò¥ Sleeper Hit</div>
                    <div class="stat-value" id="d-sleep-song">Loading...</div>
                    <div class="stat-sub" id="d-sleep-user">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ü§ù Most Agreed</div>
                    <div class="stat-value" id="d-agreed-song">Loading...</div>
                    <div class="stat-sub" id="d-agreed-score">Low Controversy</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üìä Total Songs</div>
                    <div class="stat-value" id="d-total-songs">--</div>
                    <div class="stat-sub">In current view</div>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="card">
                    <h3>üèÜ Top 5 Songs</h3>
                    <div class="table-container" id="c-dash-top5"></div>
                </div>
                <div class="card">
                    <h3>üìâ Bottom 5 Songs</h3>
                    <div class="table-container" id="c-dash-bottom5"></div>
                </div>
            </div>
        </div>

        <!-- FULL RANKINGS VIEW -->
        <div id="view-leader" class="card hidden">
            <h3>Full Community Consensus</h3>
            <div class="table-container" id="c-leaderboard"></div>
        </div>

        <!-- ANALYSIS VIEW -->
        <div id="view-more" class="grid hidden">
            <div class="dashboard-grid">
                <div class="card">
                    <h3>Most Disputed</h3>
                    <div class="table-container" id="c-disputed"></div>
                </div>
                <div class="card">
                    <h3>Controversial Tracks</h3>
                    <div class="table-container" id="c-controversy"></div>
                </div>
            </div>

            <div class="card">
                <h3>Subunit Power Rankings</h3>
                <div class="table-container" id="c-subunits"></div>
            </div>

            <div class="dashboard-grid">
                <div class="card">
                    <h3>Sleeper Picks</h3>
                    <div class="table-container" id="c-sleeper"></div>
                </div>
                <div class="card">
                    <h3>Consistent Tracks</h3>
                    <div class="table-container" id="c-consistent"></div>
                </div>
            </div>

            <div class="card">
                <h3>Outliers</h3>
                <div class="table-container" id="c-outliers"></div>
            </div>
            <div class="card">
                <h3>Top/Bottom 10</h3>
                <div class="table-container" id="c-universal"></div>
            </div>
        </div>

        <!-- DIVERGENCE VIEW -->
        <div id="view-opps" class="card hidden">
            <h3>User Divergence Matrix</h3>
            <div id="matrix-scroll-wrapper">
                <div id="c-matrix"></div>
            </div>
        </div>

        <!-- SPICE VIEW -->
        <div id="view-spice" class="card hidden">
            <h3>Global Spice Breakdown</h3>
            <div id="c-spice"></div>
        </div>

        <!-- RIVALS VIEW -->
        <div id="view-rivals" class="main-view hidden" style="padding:0; background:transparent;">
            <!-- Sub Navigation -->
            <div style="display:flex; justify-content:center; gap:15px; margin-bottom:20px;">
                <button id="rtab-constellation" class="nav-btn active" onclick="switchRivalTab('constellation')"
                    style="background:var(--pink); color:#000; border:none;">Taste Constellation</button>
                <button id="rtab-matchmaking" class="nav-btn" onclick="switchRivalTab('matchmaking')"
                    style="background:transparent; border:1px solid var(--border);">Matchmaking</button>
            </div>

            <!-- TAB 1: CONSTELLATION -->
            <div id="rview-constellation" class="card">
                <h3 style="border:none; margin-bottom:10px; text-align:center;">üåå Taste Constellation</h3>
                <div style="font-size:12px; color:var(--muted); margin-bottom:15px; text-align:center;">
                    Visualizing 147-dimensional taste differences in 2D space.
                    <button id="toggle-3d" onclick="toggle3D()"
                        style="margin-left:10px; padding:4px 10px; font-size:10px; font-weight:bold; vertical-align:middle; background:transparent; border:1px solid var(--pink); color:var(--pink); border-radius:4px; cursor:pointer; text-transform:uppercase;">Switch
                        to 3D</button>
                </div>

                <canvas id="taste-canvas"
                    style="width:100%; height:600px; background: radial-gradient(circle at center, #1b2028 0%, #0d1117 100%); border-radius:12px; border:1px solid var(--border); margin-bottom:30px;"></canvas>

                <!-- LAYMAN EXPLANATION -->
                <div
                    style="background:rgba(255,255,255,0.03); border-radius:12px; padding:25px; border:1px solid var(--border);">
                    <h4 style="margin-top:0; color:var(--pink);">How to read this graph</h4>
                    <p style="font-size:14px; color:#ccc; line-height:1.6; margin-bottom:20px;">
                        This map visualizes the "Social Geography" of taste.
                        <b>Distance = Disagreement</b>. The further apart two users are, the more they disagree on
                        rankings.
                    </p>

                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:25px;">
                        <!-- Concept 1: The Main Divide -->
                        <!-- Concept 1: The Main Divide -->
                        <div>
                            <strong
                                style="color:#fff; display:block; margin-bottom:8px; border-bottom:1px solid var(--pink); padding-bottom:5px;">1.
                                The Main Divide (X-Axis)</strong>
                            <p style="font-size:13px; color:var(--muted); margin:0;">
                                This line represents the <b>single biggest difference</b> in opinion across the whole
                                group.
                                <br><br>
                                <b style="color:var(--pink); cursor:pointer;">Click the "X" Label</b> on the graph to
                                see exactly which songs are causing this split.
                                (Usually, people on the left love a certain style, while people on the right prefer
                                another).
                            </p>
                        </div>

                        <!-- Concept 2: The Nuance -->
                        <div>
                            <strong
                                style="color:#fff; display:block; margin-bottom:8px; border-bottom:1px solid var(--pink); padding-bottom:5px;">2.
                                The Nuance (Y-Axis)</strong>
                            <p style="font-size:13px; color:var(--muted); margin:0;">
                                This difference distinguishes people who might agree on the big stuff but disagree on
                                specific details.
                                <br><br>
                                <b style="color:var(--pink); cursor:pointer;">Click the "Y" Label</b> to see the songs
                                driving these finer distinctions.
                            </p>
                        </div>

                        <!-- Concept 3: The Layout -->
                        <div>
                            <strong
                                style="color:#fff; display:block; margin-bottom:8px; border-bottom:1px solid var(--pink); padding-bottom:5px;">3.
                                The Layout</strong>
                            <p style="font-size:13px; color:var(--muted); margin:0;">
                                <b>Distance &approx; Disagreement</b>.<br>
                                Users close together typically share very similar tastes. Users far apart rarely agree.
                                Look for clusters!
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 2: MATCHMAKING -->
            <div id="rview-matchmaking" class="hidden">
                <!-- Head to Head -->
                <div class="card" style="margin-bottom:20px;">
                    <h3 style="border:none; text-align:center; font-size:18px;">üë• Head-to-Head Duel</h3>
                    <div class="selector-group"
                        style="margin-bottom:30px; justify-content:center; align-items:center; gap:20px;">
                        <select id="duel-user-a" onchange="runDuel()"
                            style="width:200px; padding:12px; font-size:16px; background:var(--card); border:2px solid var(--border);"></select>
                        <div style="font-weight:900; color:var(--red); font-size:24px; font-style:italic;">VS</div>
                        <select id="duel-user-b" onchange="runDuel()"
                            style="width:200px; padding:12px; font-size:16px; background:var(--card); border:2px solid var(--border);"></select>
                    </div>
                    <div id="duel-results" class="hidden">
                        <div style="text-align:center; margin-bottom:40px;">
                            <div
                                style="font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:2px; font-weight:700; margin-bottom:10px;">
                                Compatibility Score</div>
                            <div id="duel-score"
                                style="font-size:56px; line-height:1; font-weight:900; color:#fff; text-shadow:0 0 30px rgba(219,97,162,0.3);">
                                --%</div>
                            <div id="duel-msg"
                                style="color:var(--pink); font-size:14px; font-weight:600; margin-top:5px;">--</div>
                        </div>
                        <div class="card"
                            style="margin-bottom:20px; border-color:var(--red); background:rgba(20,20,20,0.5);">
                            <h3 style="color:var(--red); border-color:rgba(248,81,73,0.3);">‚öîÔ∏è Biggest Disagreements
                            </h3>
                            <div class="table-container" id="duel-disputes"></div>
                        </div>
                    </div>
                </div>

                <!-- Match Finder -->
                <div class="card" style="margin-bottom:20px;">
                    <h3 style="border:none; margin-bottom:20px; text-align: center;">üíò Find Your Match</h3>
                    <div
                        style="display:flex; gap:10px; align-items:center; justify-content:center; margin-bottom:20px;">
                        <select id="match-finder-user"
                            style="width:200px; padding:10px; border-radius:6px; background:#1c2128; color:white; border:1px solid #444;"></select>
                        <button class="btn-footer btn-submit-action" onclick="findMatches()"
                            style="padding:10px 20px;">Analyze</button>
                    </div>
                    <div id="match-results" class="grid"
                        style="grid-template-columns: 1fr 1fr; gap:20px; text-align:left;"></div>
                </div>

                <!-- Oshi Detector -->
                <div class="card">
                    <h3 style="border:none; margin-bottom:10px; text-align: center;">üíñ Oshi Detector</h3>
                    <div style="font-size:12px; color:var(--muted); margin-bottom:15px; text-align: center;">Who do you
                        <i>really</i> love the most? (Based on average rank)
                    </div>
                    <div
                        style="display:flex; gap:10px; align-items:center; justify-content:center; margin-bottom:15px;">
                        <select id="bias-user"
                            style="width:200px; padding:10px; background:var(--card); border:1px solid var(--border); color:#fff; border-radius:6px;"></select>
                        <button class="btn-footer btn-submit-action" onclick="analyzeBias()"
                            style="padding:10px 20px;">Detect</button>
                    </div>
                    <div id="bias-results" class="grid"
                        style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:15px;"></div>
                </div>
            </div>
        </div>

        <script>
            function switchRivalTab(tab) {
                // Update Buttons
                document.getElementById('rtab-constellation').className = tab === 'constellation' ? 'nav-btn active' : 'nav-btn';
                document.getElementById('rtab-constellation').style.background = tab === 'constellation' ? 'var(--pink)' : 'transparent';
                document.getElementById('rtab-constellation').style.color = tab === 'constellation' ? '#000' : 'var(--muted)';
                document.getElementById('rtab-constellation').style.borderColor = tab === 'constellation' ? 'transparent' : 'var(--border)';

                document.getElementById('rtab-matchmaking').className = tab === 'matchmaking' ? 'nav-btn active' : 'nav-btn';
                document.getElementById('rtab-matchmaking').style.background = tab === 'matchmaking' ? 'var(--pink)' : 'transparent';
                document.getElementById('rtab-matchmaking').style.color = tab === 'matchmaking' ? '#000' : 'var(--muted)';
                document.getElementById('rtab-matchmaking').style.borderColor = tab === 'matchmaking' ? 'transparent' : 'var(--border)';

                // Update Views
                document.getElementById('rview-constellation').classList.toggle('hidden', tab !== 'constellation');
                document.getElementById('rview-matchmaking').classList.toggle('hidden', tab !== 'matchmaking');

                // Trigger Resize/Redraw if Constellation
                if (tab === 'constellation') {
                    setTimeout(() => {
                        const cvs = document.getElementById('taste-canvas');
                        if (cvs) {
                            cvs.width = cvs.parentElement.clientWidth;
                            // Height fixed usually, but we can reset
                            if (typeof drawGraph === 'function') drawGraph();
                        }
                    }, 50);
                }
            }
        </script>

        <!-- USERS VIEW -->
        <div id="view-users" class="hidden">
            <div id="users-stats-container"></div>
            <div id="users-content">
                <div style="text-align: center; padding: 80px 20px; font-size: 18px; color: var(--muted);">
                    Loading user rankings...
                </div>
            </div>
        </div>
    </main>

    <!-- UPDATED SUBMISSION OVERLAY -->
    <div id="submission-overlay">
        <div class="modal-card">
            <span class="close-btn" onclick="toggleSubmission(false)">&times;</span>
            <h3 style="font-size: 24px; margin-bottom: 30px; border:none;">Rankings Submission</h3>

            <div class="form-group">
                <label>1. Select Franchise</label>
                <select id="sub-franchise" class="modal-select">
                    <option value="liella">Liella</option>
                    <option value="aqours">Aqours</option>
                    <option value="u's">u's</option>
                    <option value="nijigasaki">Nijigasaki</option>
                    <option value="hasunosora">Hasunosora</option>
                </select>
            </div>

            <div class="form-group">
                <label>2. Your Name</label>
                <input type="text" id="in-user" class="modal-input" placeholder="Username">
            </div>

            <div class="form-group">
                <label>3. Ranked List (Format: 1. Song - Artist)</label>
                <textarea id="in-list" class="modal-textarea"
                    placeholder="1. Starlight Prologue - Liella!&#10;2. Âßã„Åæ„Çä„ÅØÂêõ„ÅÆÁ©∫ - Liella!"></textarea>
            </div>

            <button class="submit-btn" id="submit-btn-real" onclick="postSubmission()">Post My Rankings</button>
            <div id="submit-log" style="margin-top:20px; font-size:16px;"></div>
        </div>
    </div>

    <footer>
        <div class="footer-left">
            <div id="engine-log">READY</div>
        </div>
        <div class="footer-right">
            <button class="btn-footer" onclick="recompute()">Recompute</button>
            <button class="btn-footer btn-submit-action" onclick="toggleSubmission(true)">Submit</button>
        </div>
    </footer>

    <script>
        const API = "http://localhost:8000/api/v1";
        let activeTab = 'dash', allSubgroups = [];

        // Data cache to prevent redundant API calls
        let dataCache = { key: '', ranks: null, cont: null, takes: null, spice: null, loaded: false };

        async function init() {
            await fetchMasterSubgroups();
            tab('dash'); // Force dashboard view logic on startup
        }

        async function fetchMasterSubgroups() {
            const franchises = ["liella", "aqours", "u's", "nijigasaki", "hasunosora"];
            const results = await Promise.all(franchises.map(f => fetch(`${API}/subgroups?franchise=${f}`).then(r => r.json()).catch(() => [])));
            allSubgroups = results.flat();
            updateSubgroupDropdown();
        }

        function updateSubgroupDropdown() {
            const f = document.getElementById('view-franchise').value, sel = document.getElementById("view-subgroup");
            const filtered = allSubgroups.filter(sg => sg.franchise === f);
            sel.innerHTML = filtered.map(s => `<option value="${s.name}">${s.name}</option>`).join("");
            if (filtered.some(s => s.name === "All Songs")) sel.value = "All Songs";
        }

        function changeFranchiseView() {
            dataCache = { key: '', ranks: null, cont: null, takes: null, spice: null, loaded: false }; // Clear cache
            wipeUI();
            updateSubgroupDropdown();
            syncData(true); // Force fetch
        }

        function changeSubgroupView() {
            dataCache = { key: '', ranks: null, cont: null, takes: null, spice: null, loaded: false }; // Clear cache
            wipeUI();
            syncData(true); // Force fetch
        }

        function wipeUI() {
            const ids = ['c-leaderboard', 'c-universal', 'c-disputed', 'c-subunits', 'c-controversy', 'c-sleeper', 'c-consistent', 'c-outliers', 'c-matrix', 'c-spice', 'c-dash-top5', 'c-dash-bottom5', 'duel-disputes', 'match-results'];
            ids.forEach(id => { const el = document.getElementById(id); if (el) el.innerHTML = "Refreshing..."; });
            ['d-top-song', 'd-cont-song', 'd-spice-user', 'd-sleep-song', 'd-agreed-song', 'd-total-songs'].forEach(id => document.getElementById(id).innerHTML = "...");
            document.getElementById('duel-results').classList.add('hidden');
        }

        function tab(name) {
            activeTab = name;
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById(`btn-${name}`).classList.add('active');
            document.querySelectorAll('main > div').forEach(v => v.classList.add('hidden'));
            document.getElementById(`view-${name}`).classList.remove('hidden');
            syncData(false); // Don't force, use cache if available
        }

        async function syncData(forceFetch = false) {
            const sub = document.getElementById('view-subgroup').value, f = document.getElementById('view-franchise').value;
            if (!sub) return;

            const cacheKey = `${f}|${sub}`;
            let ranks, cont, takes, spice;

            // Check if we have cached data for this franchise/subgroup
            if (!forceFetch && dataCache.loaded && dataCache.key === cacheKey) {
                // Use cached data
                ranks = dataCache.ranks;
                cont = dataCache.cont;
                takes = dataCache.takes;
                spice = dataCache.spice;
            } else {
                // Fetch fresh data
                try {
                    [ranks, cont, takes, spice] = await Promise.all([
                        fetch(`${API}/analysis/rankings?franchise=${f}&subgroup=${sub}`).then(r => r.ok ? r.json() : null),
                        fetch(`${API}/analysis/controversy?franchise=${f}&subgroup=${sub}`).then(r => r.ok ? r.json() : null),
                        fetch(`${API}/analysis/takes?franchise=${f}&subgroup=${sub}`).then(r => r.ok ? r.json() : null),
                        fetch(`${API}/analysis/spice?franchise=${f}`).then(r => r.ok ? r.json() : null)
                    ]);

                    // Store in cache
                    dataCache = { key: cacheKey, ranks, cont, takes, spice, loaded: true };
                } catch (e) {
                    console.error('Fetch error:', e);
                    return;
                }
            }

            if (!ranks || !ranks.rankings) return;

            // Always update Dashboard Stats (if available)
            updateDashboard(ranks.rankings, cont?.results, takes?.takes, spice?.results);

            // Always render full leaderboard data in background (so it's ready)
            renderLeaderboard(ranks.rankings);

            // Conditional rendering for active tabs to save DOM cycles
            if (activeTab === 'more') {
                renderUniversal(ranks.rankings, cont?.results || []); renderDisputed(takes?.takes || []);
                renderSubunitPopularity(ranks.rankings, cont?.results || [], f); renderControversy(cont?.results || []);
                renderConsistent(cont?.results || []); renderSleepers(takes?.takes || []); renderOutliers(spice?.results || []);
            }
            if (activeTab === 'opps') renderMatrix(sub, f);
            if (activeTab === 'spice') renderSpice(spice?.results || []);
            if (activeTab === 'rivals') fetchUserList();
            if (activeTab === 'users') loadUsers();
        }

        function updateDashboard(ranks, cont, takes, spice) {
            // 1. Top Song
            if (ranks.length > 0) {
                const top = ranks[0];
                document.getElementById('d-top-song').innerHTML = truncate(top.song_name, 22);
                document.getElementById('d-top-score').innerHTML = `${top.average} avg rank`;

                // Total songs count
                document.getElementById('d-total-songs').innerHTML = ranks.length;

                // Render Top 5 and Bottom 5
                renderDashTop5(ranks.slice(0, 5));
                renderDashBottom5(ranks.slice(-5).reverse());
            }

            // 2. Controversial
            if (cont && cont.length > 0) {
                const c = cont[0];
                document.getElementById('d-cont-song').innerHTML = truncate(c.song_name, 22);
                document.getElementById('d-cont-score').innerHTML = `${c.controversy_score} score`;

                // Most Agreed (lowest controversy)
                const agreed = [...cont].sort((a, b) => a.controversy_score - b.controversy_score)[0];
                if (agreed) {
                    document.getElementById('d-agreed-song').innerHTML = truncate(agreed.song_name, 22);
                    document.getElementById('d-agreed-score').innerHTML = `${agreed.controversy_score} score`;
                }
            }

            // 3. Spiciest User
            if (spice && spice.length > 0) {
                const s = spice[0];
                document.getElementById('d-spice-user').innerHTML = s.username;
                document.getElementById('d-spice-val').innerHTML = `${s.global_spice} spice`;
            }

            // 4. Sleeper Hit
            if (takes && takes.length > 0) {
                const sleeper = [...takes].sort((a, b) => a.score - b.score)[0];
                if (sleeper && sleeper.score < 0) {
                    document.getElementById('d-sleep-song').innerHTML = truncate(sleeper.song_name, 22);
                    document.getElementById('d-sleep-user').innerHTML = `Loved by ${sleeper.username}`;
                }
            }
        }

        function truncate(str, len) {
            return str.length > len ? str.substring(0, len) + '‚Ä¶' : str;
        }

        function renderDashTop5(ranks) {
            const el = document.getElementById('c-dash-top5');
            if (!el) return;
            el.innerHTML = `<table>` +
                ranks.map((s, i) => `
                    <tr>
                        <td class="col-rank" style="color:${i === 0 ? '#ffd700' : i === 1 ? '#c0c0c0' : i === 2 ? '#cd7f32' : 'var(--pink)'}">#${i + 1}</td>
                        <td>${s.song_name}</td>
                        <td class="col-metric" style="color:var(--green)">${s.average}</td>
                    </tr>
                `).join('') + `</table>`;
        }

        function renderDashBottom5(ranks) {
            const el = document.getElementById('c-dash-bottom5');
            if (!el) return;
            const total = parseInt(document.getElementById('d-total-songs')?.innerHTML) || 100;
            el.innerHTML = `<table>` +
                ranks.map((s, i) => `
                    <tr>
                        <td class="col-rank" style="color:var(--red)">#${total - i}</td>
                        <td>${s.song_name}</td>
                        <td class="col-metric" style="color:var(--red)">${s.average}</td>
                    </tr>
                `).join('') + `</table>`;
        }


        function renderLeaderboard(ranks) {
            document.getElementById('c-leaderboard').innerHTML = `<table><colgroup><col class="col-rank"><col><col class="col-metric"><col class="col-metric"></colgroup><tr><th>#</th><th>Song Name</th><th>Avg</th><th>Pts</th></tr>` +
                ranks.map((s, i) => `<tr><td class="col-rank">${i + 1}</td><td>${s.song_name}</td><td class="col-metric" style="color:var(--pink)">${s.average}</td><td class="col-metric">${s.points}</td></tr>`).join('') + `</table>`;
        }

        function renderUniversal(ranks, controversy) {
            const top = ranks.slice(0, 10), btm = ranks.slice(-10);
            const mapAgreement = (songName) => {
                const c = controversy.find(x => x.song_name === songName);
                return c ? Math.max(0, 100 - ((c.cv * c.avg_rank) * 2.5)).toFixed(1) : "0.0";
            };
            const rows = [...top, ...btm].map((s, i) => `<tr><td class="col-rank" style="color:${i < 10 ? 'var(--green)' : 'var(--red)'}">${i < 10 ? 'TOP' : 'BTM'}</td><td>${s.song_name}</td><td class="col-metric" style="color:var(--pink)">${s.average}</td><td class="col-metric">${mapAgreement(s.song_name)}%</td></tr>`).join('');
            document.getElementById('c-universal').innerHTML = `<table><colgroup><col class="col-rank"><col><col class="col-metric"><col class="col-metric"></colgroup><tr><th>Type</th><th>Song</th><th>Avg</th><th>Agr</th></tr>${rows}</table>`;
        }

        function renderDisputed(takes) {
            const songGroups = {};
            takes.forEach(t => { if (!songGroups[t.song_name]) songGroups[t.song_name] = []; songGroups[t.song_name].push(t); });
            const res = Object.keys(songGroups).map(name => {
                const g = songGroups[name].sort((a, b) => a.user_rank - b.user_rank);
                return { name, fight: `${g[0].username} vs ${g[g.length - 1].username}`, diff: Math.abs(g[g.length - 1].user_rank - g[0].user_rank) };
            }).sort((a, b) => b.diff - a.diff).slice(0, 10);
            document.getElementById('c-disputed').innerHTML = `<table><colgroup><col><col class="col-fight"><col class="col-metric"></colgroup><tr><th>Song</th><th>Fight</th><th class="col-metric">Diff</th></tr>` + res.map(r => `<tr><td>${r.name}</td><td class="col-fight">${r.fight}</td><td class="col-metric" style="color:var(--pink)">${r.diff}</td></tr>`).join('') + `</table>`;
        }

        function renderSubunitPopularity(rankings, controversy, franchise) {
            const subunits = allSubgroups.filter(sg => sg.franchise === franchise && sg.is_subunit);
            if (!subunits.length) { document.getElementById('c-subunits').innerHTML = "No subunits."; return; }
            const data = subunits.map(unit => {
                const rS = rankings.filter(r => unit.songs.includes(r.song_name)), cS = controversy.filter(r => unit.songs.includes(r.song_name));
                return { name: unit.name, avg: rS.length ? (rS.reduce((a, b) => a + b.average, 0) / rS.length).toFixed(2) : 0, div: cS.length ? (cS.reduce((a, b) => a + b.cv, 0) / cS.length).toFixed(4) : 0 };
            }).sort((a, b) => a.avg - b.avg);
            document.getElementById('c-subunits').innerHTML = `<table><colgroup><col><col class="col-metric"><col class="col-metric"></colgroup><tr><th>Unit</th><th class="col-metric">Avg</th><th class="col-metric">Div</th></tr>` + data.map(d => `<tr><td style="font-weight:bold">${d.name}</td><td class="col-metric" style="color:var(--pink)">${d.avg}</td><td class="col-metric">${d.div}</td></tr>`).join('') + `</table>`;
        }

        function renderControversy(results) { document.getElementById('c-controversy').innerHTML = `<table><colgroup><col><col class="col-metric"><col class="col-metric"></colgroup><tr><th>Song</th><th class="col-metric">Score</th><th class="col-metric">Div</th></tr>` + results.slice(0, 10).map(s => `<tr><td>${s.song_name}</td><td class="col-metric" style="color:var(--pink)">${s.controversy_score}</td><td class="col-metric">${s.cv}</td></tr>`).join('') + `</table>`; }
        function renderConsistent(results) { const sorted = [...results].sort((a, b) => a.controversy_score - b.controversy_score).slice(0, 10); document.getElementById('c-consistent').innerHTML = `<table><colgroup><col><col class="col-metric"><col class="col-metric"></colgroup><tr><th>Song</th><th class="col-metric">Score</th><th class="col-metric">Avg</th></tr>` + sorted.map(s => `<tr><td>${s.song_name}</td><td class="col-metric" style="color:var(--pink)">${s.controversy_score}</td><td class="col-metric">${s.avg_rank}</td></tr>`).join('') + `</table>`; }
        function renderSleepers(takes) { const sleepers = takes.filter(t => t.score < -15).slice(0, 10); document.getElementById('c-sleeper').innerHTML = `<table><colgroup><col><col class="col-metric"><col class="col-metric"></colgroup><tr><th>Song</th><th class="col-metric">Lover</th><th class="col-metric">Gap</th></tr>` + sleepers.map(t => `<tr><td>${t.song_name}</td><td class="col-metric">${t.username.substring(0, 8)}</td><td class="col-metric" style="color:var(--green)">${Math.abs(t.delta).toFixed(1)}</td></tr>`).join('') + `</table>`; }
        function renderOutliers(results) { if (!results || !results.length) return; const s = results.map(u => u.global_spice), min = Math.min(...s), max = Math.max(...s), r = (max - min) || 1; document.getElementById('c-outliers').innerHTML = `<table><colgroup><col><col class="col-metric"></colgroup><tr><th>User</th><th class="col-metric">Spice</th></tr>` + results.slice(0, 10).map(u => `<tr><td style="font-weight:bold">${u.username}</td><td class="metric"><div class="bar-bg" style="width:180px"><div class="bar-fill" style="width:${((u.global_spice - min) / r) * 100}%"></div><div style="font-size:10px; margin-top:-14px; margin-left:5px;">${u.global_spice}</div></div></td></tr>`).join('') + `</table>`; }

        async function renderMatrix(sub, f) {
            const wrap = document.getElementById("c-matrix"); wrap.innerHTML = "Loading...";
            try {
                const r = await fetch(`${API}/analysis/divergence?franchise=${f}&subgroup=${sub}`);
                const d = await r.json(), u = Object.keys(d.matrix).sort(), max = Math.max(...Object.values(d.matrix).flatMap(o => Object.values(o))) || 1;
                wrap.style.gridTemplateColumns = `150px repeat(${u.length}, 1fr)`;
                wrap.innerHTML = `<div></div>` + u.map(n => `<div class="m-label">${n}</div>`).join('');
                u.forEach(u1 => { wrap.innerHTML += `<div class="m-label" style="text-align:left">${u1}</div>`; u.forEach(u2 => { const v = d.matrix[u1][u2], op = Math.pow(v / max, 1.8); wrap.innerHTML += `<div class="cell" style="background:rgba(219, 97, 162, ${op}); color:${op > 0.5 ? '#fff' : '#8b949e'}; border-bottom:1px solid #0d1117;">${v}</div>`; }); });
            } catch (e) { wrap.innerHTML = "Error."; }
        }

        /* --- RIVALS LOGIC --- */
        let allUsers = [];

        async function fetchUserList() {
            const f = document.getElementById('view-franchise').value, sub = document.getElementById('view-subgroup').value;
            try {
                // Use divergence endpoint to get reliable user list
                const r = await fetch(`${API}/analysis/divergence?franchise=${f}&subgroup=${sub}`);
                const d = await r.json();
                allUsers = Object.keys(d.matrix).sort();
                // Init Graph with full data (for loading calculations)
                setTimeout(() => typeof initConstellation === 'function' && initConstellation(d), 500);

                const opts = allUsers.map(u => `<option value="${u}">${u}</option>`).join('');
                ['duel-user-a', 'duel-user-b', 'match-finder-user', 'bias-user'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el && !el.innerHTML) {  // Only populate if empty to preserve selection
                        const old = el.value;
                        el.innerHTML = '<option value="">Select User</option>' + opts;
                        if (old && allUsers.includes(old)) el.value = old;
                    } else if (el && el.innerHTML === "") {
                        el.innerHTML = '<option value="">Select User</option>' + opts;
                    }
                });
            } catch (e) { }
        }

        async function runDuel() {
            const u1 = document.getElementById('duel-user-a').value;
            const u2 = document.getElementById('duel-user-b').value;
            if (!u1 || !u2 || u1 === u2) {
                document.getElementById('duel-results').classList.add('hidden');
                return;
            }

            const f = document.getElementById('view-franchise').value, sub = document.getElementById('view-subgroup').value;
            document.getElementById('duel-score').innerHTML = "...";
            document.getElementById('duel-results').classList.remove('hidden');

            try {
                const res = await fetch(`${API}/analysis/head-to-head?franchise=${f}&subgroup=${sub}&user_a=${u1}&user_b=${u2}`);
                const data = await res.json();

                // Render Score
                const sc = data.score;
                document.getElementById('duel-score').innerHTML = `${sc}%`;
                document.getElementById('duel-score').style.color = sc > 75 ? 'var(--green)' : sc < 40 ? 'var(--red)' : '#fff';
                document.getElementById('duel-msg').innerHTML = sc > 85 ? "BEST FRIENDS FOREVER üíñ" : sc > 60 ? "Solid Compatibility üëç" : sc < 30 ? "MORTAL ENEMIES üíÄ" : "It's Complicated ü§∑";

                // Render Disputes
                const disputes = data.diffs.slice(0, 10);
                document.getElementById('duel-disputes').innerHTML = `<table>
                    <colgroup><col><col style="width:80px"><col style="width:80px"><col style="width:60px"></colgroup>
                    <tr><th>Song</th><th>${u1}</th><th>${u2}</th><th>Diff</th></tr>` +
                    disputes.map(d => `
                        <tr>
                            <td>${d.name}</td>
                            <td style="color:${d.r1 < d.r2 ? 'var(--green)' : 'var(--muted)'}">#${d.r1}</td>
                            <td style="color:${d.r2 < d.r1 ? 'var(--green)' : 'var(--muted)'}">#${d.r2}</td>
                            <td style="font-weight:bold; color:var(--red)">${Math.round(d.diff)}</td>
                        </tr>`).join('') + `</table>`;

            } catch (e) { console.error(e); document.getElementById('duel-score').innerHTML = "Err"; }
        }

        async function findMatches() {
            const u = document.getElementById('match-finder-user').value;
            if (!u) return;
            const f = document.getElementById('view-franchise').value, sub = document.getElementById('view-subgroup').value;
            const res = document.getElementById('match-results');
            res.innerHTML = "Scanning database...";

            try {
                const r = await fetch(`${API}/analysis/user-match?franchise=${f}&subgroup=${sub}&user=${u}`);
                const data = await r.json();

                const renderCard = (title, list, color) => `
                    <div class="card" style="border-color:${color}">
                        <h3 style="color:${color}; border-color:${color}; margin-bottom:10px;">${title}</h3>
                        ${list.map(x => `<div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid rgba(255,255,255,0.05)">
                            <span style="font-weight:600">${x.user}</span>
                            <span style="font-family:Consolas; opacity:0.7">Div: ${x.div.toFixed(2)}</span>
                        </div>`).join('')}
                    </div>
                `;

                res.innerHTML = renderCard("‚ù§Ô∏è Soulmates", data.soulmates, "var(--green)") +
                    renderCard("üíÄ Nemeses", data.nemeses, "var(--red)");
            } catch (e) { res.innerHTML = "Error finding matches."; }
        }

        async function analyzeBias() {
            const u = document.getElementById('bias-user').value;
            if (!u) return;
            const f = document.getElementById('view-franchise').value;
            const res = document.getElementById('bias-results');
            res.innerHTML = "Computing bias...";

            try {
                const r = await fetch(`${API}/analysis/oshi-bias?franchise=${f}&user=${u}`);
                const d = await r.json();

                if (d.error) { res.innerHTML = d.error; return; }

                let html = '';
                d.biases.forEach((b, i) => {
                    html += `
                     <div class="stat-card" style="padding:15px; border-color:${i === 0 ? 'var(--pink)' : 'var(--border)'}">
                        <div style="font-size:10px; opacity:0.7; text-transform:uppercase; letter-spacing:1px;">${i === 0 ? 'üèÜ OSHI' : 'Favored Member'}</div>
                        <div style="font-size:16px; font-weight:bold; color:#fff; margin:5px 0;">${b.name}</div>
                        <div style="font-size:24px; font-weight:900; color:${i === 0 ? 'var(--pink)' : 'var(--green)'}">+${b.bias}</div>
                        <div style="font-size:11px; opacity:0.5; margin-top:5px;">Avg Rank #${b.avg_rank} (${b.count} songs)</div>
                     </div>`;
                });
                res.innerHTML = html || "No significant bias found (You love everyone equally?).";
            } catch (e) { console.error(e); res.innerHTML = "Error."; }
        }



        /* --- CONSTELLATION GRAPH --- */
        let graphCtx = null, graphNodes = [], graphEdges = [], graphAnimParams = { w: 0, h: 0 };
        let graphHover = null, graphDrag = null, graphMouse = { x: 0, y: 0 };

        // --- Math Helpers for MDS ---
        const MathLib = {
            mean: (arr) => arr.reduce((a, b) => a + b, 0) / arr.length,
            pearson: (x, y) => {
                const n = x.length;
                if (n !== y.length || n === 0) return 0;
                const mx = MathLib.mean(x), my = MathLib.mean(y);
                let num = 0, dx2 = 0, dy2 = 0;
                for (let i = 0; i < n; i++) {
                    const dx = x[i] - mx, dy = y[i] - my;
                    num += dx * dy;
                    dx2 += dx * dx;
                    dy2 += dy * dy;
                }
                return (dx2 === 0 || dy2 === 0) ? 0 : num / Math.sqrt(dx2 * dy2);
            },
            jacobi: (A, tol = 1e-8, maxIter = 100) => {
                const n = A.length;
                let V = Array(n).fill(0).map((_, i) => Array(n).fill(0).map((_, j) => i === j ? 1 : 0));
                let D = A.map(row => [...row]);
                for (let iter = 0; iter < maxIter; iter++) {
                    let maxVal = 0, p = 0, q = 0;
                    for (let i = 0; i < n - 1; i++) for (let j = i + 1; j < n; j++) if (Math.abs(D[i][j]) > maxVal) { maxVal = Math.abs(D[i][j]); p = i; q = j; }
                    if (maxVal < tol) break;
                    const phi = 0.5 * Math.atan2(2 * D[p][q], D[q][q] - D[p][p]);
                    const c = Math.cos(phi), s = Math.sin(phi);
                    for (let i = 0; i < n; i++) {
                        let t = D[i][p]; D[i][p] = c * t - s * D[i][q]; D[i][q] = s * t + c * D[i][q];
                        t = V[i][p]; V[i][p] = c * t - s * V[i][q]; V[i][q] = s * t + c * V[i][q];
                    }
                    for (let i = 0; i < n; i++) {
                        D[p][i] = D[i][p]; D[q][i] = D[i][q];
                    }
                    D[p][p] = c * D[p][p] * c - 2 * s * D[p][q] * c + s * D[q][q] * s;
                    D[q][q] = s * D[p][p] * s + 2 * s * D[p][q] * c + c * D[q][q] * c;
                    D[p][q] = D[q][p] = 0;
                }
                const eig = D.map((r, i) => ({ val: r[i], vec: V.map(row => row[i]) }));
                return eig.sort((a, b) => b.val - a.val);
            },
            mds: (distMatrix) => {
                const n = distMatrix.length;
                const D2 = distMatrix.map(row => row.map(v => v * v));
                const rowMeans = D2.map(r => MathLib.mean(r));
                const colMeans = Array(n).fill(0).map((_, i) => MathLib.mean(D2.map(r => r[i])));
                const matrixMean = MathLib.mean(rowMeans);
                const B = Array(n).fill(0).map((_, i) => Array(n).fill(0).map((_, j) =>
                    -0.5 * (D2[i][j] - rowMeans[i] - colMeans[j] + matrixMean)
                ));
                const eig = MathLib.jacobi(B);

                // Calculate variance explained by top 2 dimensions
                const positiveEigs = eig.filter(e => e.val > 0).map(e => e.val);
                const totalVar = positiveEigs.reduce((a, b) => a + b, 0);
                const explainedVar = (positiveEigs.length >= 2 && totalVar > 0)
                    ? ((positiveEigs[0] + positiveEigs[1]) / totalVar) * 100
                    : 100;

                const X = eig[0].val > 0 ? eig[0].vec.map(v => v * Math.sqrt(eig[0].val)) : Array(n).fill(0);
                const Y = eig[1].val > 0 ? eig[1].vec.map(v => v * Math.sqrt(eig[1].val)) : Array(n).fill(0);
                const Z = (eig[2] && eig[2].val > 0) ? eig[2].vec.map(v => v * Math.sqrt(eig[2].val)) : Array(n).fill(0);

                return {
                    coords: X.map((x, i) => ({ x, y: Y[i], z: Z[i] })),
                    varianceExplained: Math.round(explainedVar)
                };
            }
        };

        let graphVarianceExplained = 0; // Store for legend
        let graphPC1Songs = []; // Top 3 songs defining X-axis
        let graphPC2Songs = []; // Top 3 songs defining Y-axis

        function initConstellation(data) {
            // data = { matrix: {...}, rankings: {...}, song_names: {...} }
            const matrixData = data.matrix;
            const songRankings = data.rankings || {};
            const songNames = data.song_names || {};
            const cvs = document.getElementById('taste-canvas');
            if (!cvs || !matrixData) return;
            const rect = cvs.getBoundingClientRect();
            cvs.width = rect.width; cvs.height = rect.height;
            graphCtx = cvs.getContext('2d');

            const users = Object.keys(matrixData);
            const distMatrix = users.map(u1 => users.map(u2 => matrixData[u1][u2]));

            let mdsResult;
            try { mdsResult = MathLib.mds(distMatrix); } catch (e) { console.error("MDS Failed", e); return; }

            const coords = mdsResult.coords;
            graphVarianceExplained = mdsResult.varianceExplained;

            let maxDist = 0;
            coords.forEach(p => {
                const d = Math.max(Math.abs(p.x), Math.abs(p.y));
                if (d > maxDist) maxDist = d;
            });

            const padding = 60;
            const w = cvs.width, h = cvs.height;

            // Scale to fit the furthest point within the canvas (keeping origin at center)
            const fitScale = (Math.min(w, h) / 2 - padding) / (maxDist || 1);

            // Use Uniform Scaling to preserve Aspect Ratio (Distance = Divergence)
            // Engineers expect Euclidean space to be consistent.
            const scale = fitScale;

            graphNodes = users.map((u, i) => ({
                id: u,
                x: coords[i].x * scale + w / 2,
                y: coords[i].y * scale + h / 2,

                // 3D Real World Coords (Centered)
                realX: coords[i].x * scale,
                realY: coords[i].y * scale,
                realZ: coords[i].z * scale,

                color: `hsl(${280 + ((i * 40) % 80)}, 70%, 60%)`,
                initials: u.substring(0, 2).toUpperCase(),
                pc1: coords[i].x, // Store raw PC coords for loading calc
                pc2: coords[i].y,
                pc3: coords[i].z
            }));

            // Compute Song Loadings (Pearson correlation of song ranks with PC scores)
            const pc1Coords = graphNodes.map(n => n.pc1);
            const pc2Coords = graphNodes.map(n => n.pc2);
            const pc3Coords = graphNodes.map(n => n.pc3);

            const songLoadings = [];
            for (const [songId, userRanks] of Object.entries(songRankings)) {
                // Build rank vector aligned with users array
                const rankVec = users.map(u => userRanks[u] ?? 0);

                // Pearson correlation with PC scores
                const r1 = MathLib.pearson(rankVec, pc1Coords);
                const r2 = MathLib.pearson(rankVec, pc2Coords);
                const r3 = MathLib.pearson(rankVec, pc3Coords);

                songLoadings.push({
                    id: songId,
                    name: songNames[songId] || songId.substring(0, 8),
                    pc1: r1,
                    pc2: r2,
                    pc3: r3
                });
            }

            // Helper to generate "Vs" labels
            const getAxisLabel = (loadings, axisName) => {
                const sorted = [...loadings].sort((a, b) => Math.abs(b[axisName]) - Math.abs(a[axisName]));
                if (sorted.length < 1) return `${axisName.toUpperCase()}: Variance`;
                const s1 = sorted[0];
                const s2 = sorted[1];

                // If only 1 song or 2nd is weak, just show top
                if (!s2 || Math.abs(s2[axisName]) < 0.3) {
                    return `${axisName.toUpperCase()}: Polarized by "${s1.name}"`;
                }
                // If signs oppose, it's a VS
                if (Math.sign(s1[axisName]) !== Math.sign(s2[axisName])) {
                    return `${axisName.toUpperCase()}: "${s1.name}" vs "${s2.name}"`;
                } else {
                    return `${axisName.toUpperCase()}: Driven by "${s1.name}" & "${s2.name}"`;
                }
            };

            window.graphAxisLabels = {
                x: getAxisLabel(songLoadings, 'pc1'),
                y: getAxisLabel(songLoadings, 'pc2'),
                z: getAxisLabel(songLoadings, 'pc3')
            };

            // Store full data for drill-down
            window.graphAxisData = {
                pc1: [...songLoadings].sort((a, b) => Math.abs(b.pc1) - Math.abs(a.pc1)),
                pc2: [...songLoadings].sort((a, b) => Math.abs(b.pc2) - Math.abs(a.pc2)),
                pc3: [...songLoadings].sort((a, b) => Math.abs(b.pc3) - Math.abs(a.pc3))
            };

            // Global helper for showing details (simple alert for now, can be modal later)
            window.showAxisDetails = (title, data, key) => {
                const top10 = data.slice(0, 10);
                const msg = top10.map((s, i) => `${i + 1}. ${s.name} (${s[key] > 0 ? '+' : ''}${s[key].toFixed(2)})`).join('\n');
                alert(`${title} Drivers (Pearson Correlation):\n\n${msg}\n\n(High magnitude = Strong driver of this axis)`);
            };

            // Click Handler for Drill-Down
            cvs.onclick = e => {
                const r = cvs.getBoundingClientRect();
                const x = e.clientX - r.left, y = e.clientY - r.top;
                const w = cvs.width, h = cvs.height;
                const cx = w / 2, cy = h / 2;

                // Click X-Axis Label (Right area)
                if (x > w - 300 && Math.abs(y - cy) < 40) {
                    window.showAxisDetails('X-Axis', window.graphAxisData.pc1, 'pc1');
                }
                // Click Y-Axis Label (Top center area)
                else if (Math.abs(x - cx) < 200 && y < 60) {
                    window.showAxisDetails('Y-Axis', window.graphAxisData.pc2, 'pc2');
                }
            };

            // Find top polarizing songs for each axis (keep for reference)
            graphPC1Songs = window.graphAxisData.pc1.slice(0, 3).map(s => s.name);
            graphPC2Songs = window.graphAxisData.pc2.slice(0, 3).map(s => s.name);

            // No edges needed (user requested removal)

            // Events
            // Drag State
            window.graphIsDragging = false;
            window.graphLastMouseX = 0;
            window.graphAutoRotate = true;

            cvs.onmousedown = e => {
                if (window.graphIs3D) {
                    window.graphIsDragging = true;
                    window.graphLastMouseX = e.clientX;
                    window.graphAutoRotate = false;
                    cvs.style.cursor = 'grabbing';
                }
            };
            cvs.onmouseup = e => {
                window.graphIsDragging = false;
                if (window.graphIs3D) cvs.style.cursor = 'grab';
            };
            cvs.onmouseleave = cvs.onmouseup;

            // Events
            cvs.onmousemove = e => {
                const r = cvs.getBoundingClientRect();
                const mx = e.clientX - r.left, my = e.clientY - r.top;

                // 3D Logic
                if (window.graphIs3D) {
                    if (window.graphIsDragging) {
                        const delta = e.clientX - window.graphLastMouseX;
                        window.graphRotation += delta * 0.005;
                        window.graphLastMouseX = e.clientX;
                    } else {
                        cvs.style.cursor = 'grab';
                    }
                    return; // Skip 2D hover logic
                }

                // Node Hover
                graphHover = graphNodes.find(n => Math.hypot(n.x - mx, n.y - my) < 12);

                // Axis Hover
                const w = cvs.width, h = cvs.height, cx = w / 2, cy = h / 2;
                window.graphHoverLabel = null;
                if (mx > w - 300 && Math.abs(my - cy) < 40) window.graphHoverLabel = 'x';
                else if (Math.abs(mx - cx) < 200 && my < 60) window.graphHoverLabel = 'y';

                // Cursor
                cvs.style.cursor = (graphHover || window.graphHoverLabel) ? 'pointer' : 'default';

                if (typeof drawGraph === 'function') drawGraph();
            };

            if (typeof drawGraph === 'function') drawGraph();
        }

        function drawGraph() {
            if (!graphCtx || window.graphIs3D) return;
            const cvs = document.getElementById('taste-canvas');
            const w = cvs.width, h = cvs.height;

            graphCtx.clearRect(0, 0, w, h);

            // Background Structure (to make it look less random)
            const cx = w / 2, cy = h / 2;

            graphCtx.save();
            graphCtx.strokeStyle = 'rgba(219, 97, 162, 0.1)'; // Theme pink, very faint
            graphCtx.lineWidth = 1;
            graphCtx.fillStyle = 'rgba(255, 255, 255, 0.2)';
            graphCtx.font = '9px Inter, monospace';
            graphCtx.textAlign = 'center';
            graphCtx.textBaseline = 'middle';

            // Find the global max distance for grid scaling (from graphNodes)
            // graphNodes are already centered at cx, cy
            let maxNodeDist = 0;
            graphNodes.forEach(n => {
                maxNodeDist = Math.max(maxNodeDist, Math.abs(n.x - cx), Math.abs(n.y - cy));
            });
            // Round up to nearest 100 for nice grid
            const gridStep = 100;
            const maxGrid = Math.ceil(maxNodeDist / gridStep) * gridStep + gridStep;

            // Concentric circles (Radar style) with labels
            for (let r = gridStep; r <= maxGrid; r += gridStep) {
                graphCtx.beginPath();
                graphCtx.arc(cx, cy, r, 0, Math.PI * 2);
                graphCtx.stroke();
                // Axis labels
                graphCtx.fillText(r, cx + r, cy);
                graphCtx.fillText(-r, cx - r, cy);
            }

            // Crosshairs with Labels
            graphCtx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            graphCtx.beginPath(); graphCtx.moveTo(0, cy); graphCtx.lineTo(w, cy); graphCtx.stroke();
            graphCtx.beginPath(); graphCtx.moveTo(cx, 0); graphCtx.lineTo(cx, h); graphCtx.stroke();

            // Axis Labels (with Defining Songs)
            // Axis Labels (with Defining Songs)
            graphCtx.font = 'italic 10px Inter, sans-serif';

            // X-Axis
            graphCtx.textAlign = 'right';
            const pc1Label = window.graphAxisLabels ? window.graphAxisLabels.x : (graphPC1Songs.length ? `X: Polarized by "${graphPC1Songs[0]}"` : "X: Primary Variance");
            graphCtx.fillStyle = (window.graphHoverLabel === 'x') ? '#fff' : 'rgba(255, 255, 255, 0.4)';
            graphCtx.fillText(pc1Label, w - 10, cy - 6);
            if (window.graphHoverLabel === 'x') {
                const m = graphCtx.measureText(pc1Label);
                graphCtx.fillRect(w - 10 - m.width, cy - 4, m.width, 1);
            }

            // Y-Axis
            graphCtx.textAlign = 'center';
            const pc2Label = window.graphAxisLabels ? window.graphAxisLabels.y : (graphPC2Songs.length ? `Y: Polarized by "${graphPC2Songs[0]}"` : "Y: Secondary Variance");
            graphCtx.fillStyle = (window.graphHoverLabel === 'y') ? '#fff' : 'rgba(255, 255, 255, 0.4)';
            graphCtx.fillText(pc2Label, cx, 20);
            if (window.graphHoverLabel === 'y') {
                const m = graphCtx.measureText(pc2Label);
                graphCtx.fillRect(cx - m.width / 2, 22, m.width, 1);
            }

            // Origin Label
            graphCtx.textAlign = 'center';
            graphCtx.fillText("0", cx + 5, cy + 10);

            // Legend / Explanation
            graphCtx.fillStyle = 'rgba(255, 255, 255, 0.5)';
            graphCtx.font = 'bold 12px Inter, sans-serif';
            graphCtx.textAlign = 'left'; graphCtx.textBaseline = 'bottom';
            graphCtx.fillText("TASTE CONSTELLATION (Multidimensional Scaling)", 20, h - 75);

            graphCtx.font = '10px Inter, sans-serif'; graphCtx.fillStyle = 'rgba(255, 255, 255, 0.4)';
            graphCtx.fillText("‚Ä¢ Center (0,0): Community Consensus (Average Taste)", 20, h - 55);
            graphCtx.fillText("‚Ä¢ Distance: RMS Taste Divergence (Length of difference vector)", 20, h - 40);
            graphCtx.fillText("‚Ä¢ Projection: Top 2 Principal Components (PC1 & PC2) of variance", 20, h - 25);
            graphCtx.fillText(`‚Ä¢ 2D Accuracy: ${graphVarianceExplained}% (captures nearly all structure)`, 20, h - 10);
            graphCtx.restore();

            // No Edges (removed per user feedback)

            // Nodes (smaller for less overlap)
            graphNodes.forEach(n => {
                graphCtx.shadowBlur = 0;
                // Border
                graphCtx.fillStyle = '#161b22';
                graphCtx.beginPath(); graphCtx.arc(n.x, n.y, 12, 0, Math.PI * 2); graphCtx.fill();
                // Color
                graphCtx.fillStyle = n.color;
                graphCtx.beginPath(); graphCtx.arc(n.x, n.y, 10, 0, Math.PI * 2); graphCtx.fill();

                // Label (Full Name) - draw below the node
                graphCtx.fillStyle = "rgba(255, 255, 255, 0.8)";
                graphCtx.font = "bold 9px Inter, sans-serif";
                graphCtx.textAlign = "center"; graphCtx.textBaseline = "top";
                graphCtx.fillText(n.id, n.x, n.y + 14);

                // Hover glow
                if (graphHover === n) {
                    graphCtx.shadowBlur = 15; graphCtx.shadowColor = n.color;
                }
            });
        }

        // 3D Visualizer Logic
        window.graphIs3D = false;
        window.graphRotation = 0;
        let graphAnimFrame = null;

        window.toggle3D = () => {
            window.graphIs3D = !window.graphIs3D;
            const btn = document.getElementById('toggle-3d');
            const cvs = document.getElementById('taste-canvas');
            if (window.graphIs3D) {
                btn.innerHTML = "SWITCH TO 2D";
                btn.style.background = "var(--pink)";
                btn.style.color = "#000";
                // Start Loop
                window.graphRotation = 0;
                if (graphAnimFrame) cancelAnimationFrame(graphAnimFrame);
                animate3D();
            } else {
                btn.innerHTML = "SWITCH TO 3D";
                btn.style.background = "transparent";
                btn.style.color = "var(--pink)";
                if (graphAnimFrame) cancelAnimationFrame(graphAnimFrame);
                drawGraph(); // Draw 2D
                cvs.style.cursor = 'default';
            }
        };

        function animate3D() {
            if (!window.graphIs3D) return;
            if (window.graphAutoRotate) {
                window.graphRotation += 0.005;
            }
            drawGraph3D();
            graphAnimFrame = requestAnimationFrame(animate3D);
        }

        window.drawGraph3D = () => {
            if (!graphCtx) return;
            const cvs = document.getElementById('taste-canvas');
            const w = cvs.width, h = cvs.height;
            const cx = w / 2, cy = h / 2;

            graphCtx.clearRect(0, 0, w, h);

            // 3D Config
            const fov = 500;
            const cameraZ = 600;
            const cos = Math.cos(window.graphRotation);
            const sin = Math.sin(window.graphRotation);

            // Project Helper
            const project = (x, y, z) => {
                const x3 = x * cos - z * sin;
                const y3 = y;
                const z3 = x * sin + z * cos;
                const depth = z3;
                const dist = cameraZ - depth;
                if (dist <= 0) return null;
                const scale = fov / dist;
                return { x: x3 * scale + cx, y: y3 * scale + cy, scale, depth };
            };

            // Draw Title
            graphCtx.fillStyle = 'rgba(255,255,255,0.5)';
            graphCtx.font = '12px Inter';
            graphCtx.textAlign = 'left'; graphCtx.textBaseline = 'top';
            const title = window.graphAutoRotate ? "3D Mode - Auto-Rotating" : "3D Mode - Drag to Rotate";
            graphCtx.fillText(title, 20, 20);

            // Draw Axes
            const axisLen = 300;
            const axes = [
                { s: [-axisLen, 0, 0], e: [axisLen, 0, 0], c: '#ff4444', l: 'X' },
                { s: [0, -axisLen, 0], e: [0, axisLen, 0], c: '#44ff44', l: 'Y' },
                { s: [0, 0, -axisLen], e: [0, 0, axisLen], c: '#4488ff', l: 'Z' }
            ];

            axes.forEach(ax => {
                const p1 = project(...ax.s);
                const p2 = project(...ax.e);
                if (p1 && p2) {
                    graphCtx.beginPath();
                    graphCtx.strokeStyle = ax.c;
                    graphCtx.lineWidth = 1; graphCtx.globalAlpha = 0.5;
                    graphCtx.moveTo(p1.x, p1.y);
                    graphCtx.lineTo(p2.x, p2.y);
                    graphCtx.stroke();
                    graphCtx.globalAlpha = 1;
                    // Short Label
                    graphCtx.fillStyle = ax.c;
                    graphCtx.font = 'bold 12px Inter';
                    graphCtx.textAlign = 'center';
                    graphCtx.fillText(ax.l, p2.x, p2.y);

                    // Full Label (Song Drivers)
                    if (window.graphAxisLabels) {
                        const labelKey = ax.l.toLowerCase();
                        const fullLabel = window.graphAxisLabels[labelKey];
                        if (fullLabel) {
                            graphCtx.font = '10px Inter';
                            graphCtx.fillStyle = 'rgba(255,255,255,0.7)';
                            graphCtx.fillText(fullLabel, p2.x, p2.y + 15);
                        }
                    }
                }
            });

            // Draw Nodes
            const projected = graphNodes.map(n => {
                const p = project(n.realX, n.realY, n.realZ);
                return p ? { ...n, x2d: p.x, y2d: p.y, scale: p.scale, depth: p.depth } : { ...n, scale: 0 };
            });

            // Sort: draw furthest first
            projected.sort((a, b) => a.scale - b.scale);

            projected.forEach(n => {
                if (n.scale <= 0) return;

                const size = Math.max(1, 8 * n.scale);
                graphCtx.beginPath();
                graphCtx.fillStyle = n.color;
                // Fade distant nodes
                graphCtx.globalAlpha = Math.min(1, Math.max(0.1, n.scale));
                graphCtx.arc(n.x2d, n.y2d, size, 0, Math.PI * 2);
                graphCtx.fill();

                // Text for closer nodes
                if (n.scale > 0.8) {
                    graphCtx.fillStyle = '#fff';
                    graphCtx.font = `bold ${Math.max(9, 12 * n.scale)}px Inter`;
                    graphCtx.textAlign = 'center';
                    graphCtx.fillText(n.initials, n.x2d, n.y2d + size + 5);
                }
                graphCtx.globalAlpha = 1;
            });
        };

        function renderSpice(results) {
            if (!results || !results.length) return;
            const s = results.map(u => u.global_spice), min = Math.min(...s), max = Math.max(...s), r = (max - min) || 1;
            document.getElementById('c-spice').innerHTML = results.map(u => {
                const norm = ((u.global_spice - min) / r) * 100;
                return `<div style="margin-bottom:30px;"><div style="display:flex; justify-content:space-between; font-size:24px;"><strong>${u.username}</strong><span class="metric">${u.global_spice}</span></div><div class="bar-bg" style="height:24px"><div class="bar-fill" style="width:${norm}%"></div></div></div>`;
            }).join('');
        }

        function toggleSubmission(show) { document.getElementById('submission-overlay').style.display = show ? 'flex' : 'none'; }

        // UPDATED SUBMISSION LOGIC
        async function postSubmission() {
            const log = document.getElementById('submit-log');
            const user = document.getElementById('in-user').value.trim();
            const list = document.getElementById('in-list').value.trim();
            const f = document.getElementById('sub-franchise').value;
            const btn = document.getElementById('submit-btn-real');

            // Validation: Ensure fields are non-empty
            if (!user || !list) {
                log.innerHTML = `<span style="color:var(--red)">Username and list are required.</span>`;
                return;
            }

            btn.disabled = true;
            log.innerHTML = "POSTING DATA...";

            try {
                const r = await fetch(`${API}/submit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: user,
                        franchise: f,
                        subgroup_name: "All Songs",
                        ranking_list: list
                    })
                });
                const d = await r.json();
                if (d.status === "VALID") {
                    log.innerHTML = `<span style="color:var(--green)">SUCCESSFULLY SUBMITTED!</span>`;
                    setTimeout(() => {
                        toggleSubmission(false);
                        btn.disabled = false;
                    }, 1500);
                } else {
                    let firstErr = Object.values(d.conflicts)[0];
                    log.innerHTML = `<span style="color:var(--red)">VALIDATION ERROR: Line ${firstErr.line_num} (${firstErr.reason})</span>`;
                    btn.disabled = false;
                }
            } catch (e) {
                log.innerHTML = `<span style="color:var(--red)">CONNECTION ERROR.</span>`;
                btn.disabled = false;
            }
        }

        async function loadUsers() {
            const franchise = document.getElementById('view-franchise').value;
            const subgroup = document.getElementById('view-subgroup').value;
            const content = document.getElementById('users-content');
            const statsContainer = document.getElementById('users-stats-container');

            content.innerHTML = '<div style="text-align: center; padding: 80px 20px; font-size: 18px; color: var(--muted);">Loading rankings...</div>';
            statsContainer.innerHTML = '';

            try {
                const [rankingsRes, spiceRes] = await Promise.all([
                    fetch(`${API}/users/rankings?franchise=${franchise}&subgroup=${encodeURIComponent(subgroup)}`),
                    fetch(`${API}/analysis/spice?franchise=${franchise}`)
                ]);

                if (!rankingsRes.ok) throw new Error(`API returned ${rankingsRes.status}`);

                const data = await rankingsRes.json();
                const spiceData = spiceRes.ok ? await spiceRes.json() : { results: [] };
                const spiceMap = {};
                (spiceData.results || []).forEach(u => spiceMap[u.username] = u.global_spice);

                // Calculate aggregate stats
                const avgSongsRanked = data.users.length > 0
                    ? Math.round(data.users.reduce((a, u) => a + u.total_songs, 0) / data.users.length)
                    : 0;

                // Stats Bar
                statsContainer.innerHTML = `
                    <div class="dashboard-grid" style="margin-bottom: 25px;">
                        <div class="stat-card">
                            <div class="stat-label">Total Users</div>
                            <div class="stat-value">${data.total_users}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Franchise</div>
                            <div class="stat-value">${capitalize(data.franchise)}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Avg. Songs Ranked</div>
                            <div class="stat-value">${avgSongsRanked}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Subgroup</div>
                            <div class="stat-value" style="font-size:18px">${subgroup}</div>
                        </div>
                    </div>
                `;

                if (data.users.length === 0) {
                    content.innerHTML = '<div style="text-align: center; padding: 60px 20px; color: var(--muted);"><p>No rankings found for this selection.</p></div>';
                    return;
                }

                const grid = document.createElement('div');
                grid.className = 'user-grid';

                data.users.forEach(user => {
                    const card = document.createElement('div');
                    card.className = 'user-card';

                    // Find user's #1 pick
                    const topPick = user.rankings.length > 0 ? user.rankings[0].song_name : 'N/A';

                    // User spice level
                    const spice = spiceMap[user.username] || 'N/A';

                    const rankingsList = user.rankings.map((r, i) => {
                        let rankClass = '';
                        let itemClass = '';
                        if (i === 0) { rankClass = 'gold'; itemClass = 'top-3'; }
                        else if (i === 1) { rankClass = 'silver'; itemClass = 'top-3'; }
                        else if (i === 2) { rankClass = 'bronze'; itemClass = 'top-3'; }

                        return `
                            <div class="rank-item ${itemClass}">
                                <div class="rank-number ${rankClass}">#${r.rank}</div>
                                <div class="song-name">${r.song_name}</div>
                            </div>
                        `;
                    }).join('');

                    card.innerHTML = `
                        <div class="user-header">
                            <div class="user-name">${user.username}</div>
                            <div class="song-count">${user.total_songs} songs</div>
                        </div>
                        <div class="user-insights">
                            <div class="insight-item">
                                <div class="insight-label">Top Pick</div>
                                <div class="insight-value green">${truncate(topPick, 20)}</div>
                            </div>
                            <div class="insight-item">
                                <div class="insight-label">Spice Level</div>
                                <div class="insight-value yellow">${spice}</div>
                            </div>
                        </div>
                        <div class="rankings-list">
                            ${rankingsList}
                        </div>
                    `;

                    grid.appendChild(card);
                });

                content.innerHTML = '';
                content.appendChild(grid);

            } catch (error) {
                console.error('Error loading rankings:', error);
                content.innerHTML = `<div style="background: rgba(248, 81, 73, 0.15); border: 1px solid var(--red); color: var(--red); padding: 20px; border-radius: 10px; margin: 20px 0; text-align: center; font-weight: 600;">Failed to load rankings: ${error.message}</div>`;
            }
        }

        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        async function recompute() {
            document.getElementById('engine-log').innerText = "CALCULATING...";
            await fetch(`${API}/analysis/trigger`, { method: 'POST' });
            setTimeout(() => { syncData(); document.getElementById('engine-log').innerText = "READY"; }, 3000);
        }

        init();
    </script>
</body>

</html>