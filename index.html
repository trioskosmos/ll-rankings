<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Master Rankings Suite</title>
    <style>
        :root {
            /* Premium Dark Theme */
            --bg: #0d1117;
            --card: #161b22;
            --border: #30363d;
            --pink: #db61a2;
            /* Softer premium pink */
            --green: #3fb950;
            --red: #f85149;
            --yellow: #d29922;
            --purple: #a371f7;
            --text: #c9d1d9;
            --muted: #8b949e;
            --font-size-base: 16px;
            /* Reset to standard accessible size */
        }

        /* ... Reset ... */

        body {
            font-family: 'Segoe UI', -apple-system, sans-serif;
            /* Cleaner font stack */
            background: var(--bg);
            color: var(--text);
            margin: 0;
            font-size: var(--font-size-base);
            min-height: 100vh;
            overflow-x: hidden;
            letter-spacing: 0.02em;
        }

        /* --- CONTROLS & HEADER --- */
        select {
            background: #21262d;
            /* Distinct background */
            color: #fff;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
        }

        /* Fix for invisible text in some browsers */
        option {
            background: var(--bg);
            color: var(--text);
        }

        /* --- LAYOUT --- */
        * {
            box-sizing: border-box;
        }

        header {
            background: var(--card);
            border-bottom: 1px solid var(--border);
            padding: 15px 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        h1 {
            font-size: 18px;
            margin: 0;
            color: #fff;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .selector-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .selector-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg);
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--border);
        }

        .selector-wrapper label {
            font-size: 9px;
            text-transform: uppercase;
            color: var(--muted);
            font-weight: 700;
            letter-spacing: 1px;
        }

        .nav {
            display: flex;
            gap: 8px;
            margin-left: auto;
            flex-wrap: wrap;
        }

        .nav-item {
            cursor: pointer;
            color: var(--muted);
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            padding: 8px 14px;
            border-radius: 6px;
            background: transparent;
            border: 1px solid transparent;
            transition: all 0.2s ease;
        }

        .nav-item:hover {
            color: var(--text);
            background: rgba(255, 255, 255, 0.05);
        }

        .nav-item.active {
            color: var(--pink);
            background: rgba(219, 97, 162, 0.1);
            border-color: var(--pink);
        }

        /* --- MAIN CONTENT --- */
        main {
            padding: 25px;
            padding-bottom: 100px;
            max-width: 1800px;
            margin: 0 auto;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
        }

        @media (min-width: 1200px) {
            .grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            transition: border-color 0.2s ease;
        }

        .card:hover {
            border-color: #444c56;
        }

        h3 {
            margin: 0 0 15px 0;
            color: #fff;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }

        /* --- TABLES --- */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 10px 8px;
            color: var(--muted);
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid var(--border);
        }

        td {
            padding: 12px 8px;
            border-bottom: 1px solid rgba(48, 54, 61, 0.5);
            font-size: 14px;
            vertical-align: middle;
        }

        tr:hover td {
            background: rgba(255, 255, 255, 0.02);
        }

        .col-rank {
            width: 50px;
            font-weight: 800;
            color: var(--pink);
            font-family: 'Consolas', monospace;
        }

        .col-metric {
            width: 80px;
            text-align: right;
            font-family: 'Consolas', monospace;
            font-weight: 600;
        }

        .col-fight {
            width: 160px;
            font-size: 11px;
            color: var(--muted);
            font-style: italic;
        }

        /* --- MATRIX --- */
        #matrix-scroll-wrapper {
            overflow-x: auto;
        }

        #c-matrix {
            display: grid;
            gap: 2px;
            margin-top: 10px;
            width: fit-content;
        }

        .cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 700;
            min-width: 50px;
        }

        .m-label {
            font-size: 10px;
            color: var(--muted);
            padding: 8px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* --- FOOTER --- */
        footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--card);
            border-top: 1px solid var(--border);
            padding: 12px 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 100;
        }

        .footer-right {
            display: flex;
            gap: 10px;
        }

        .btn-footer {
            background: var(--bg);
            color: var(--text);
            border: 1px solid var(--border);
            padding: 10px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-footer:hover {
            background: var(--border);
        }

        .btn-submit-action {
            background: var(--pink);
            color: #000;
            border: none;
        }

        .btn-submit-action:hover {
            background: #e54d93;
        }

        #engine-log {
            font-size: 11px;
            font-family: 'Consolas', monospace;
            color: var(--muted);
        }

        /* --- VISUALS --- */
        .bar-bg {
            height: 18px;
            background: #21262d;
            border-radius: 4px;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--pink) 0%, var(--purple) 100%);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* --- DASHBOARD GRID --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 18px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 18px;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 140px;
            transition: all 0.2s ease;
        }

        .stat-card:hover {
            border-color: var(--pink);
            transform: translateY(-2px);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 3px;
            height: 100%;
            background: var(--pink);
        }

        .stat-label {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--muted);
            letter-spacing: 1px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 800;
            color: #fff;
            line-height: 1.2;
            margin-bottom: 4px;
        }

        .stat-sub {
            font-size: 13px;
            color: var(--pink);
            font-weight: 600;
            margin-top: auto;
        }

        /* --- SUBMISSION PAGE DESIGN --- */
        #submission-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(13, 17, 23, 0.98);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
        }

        .modal-card {
            width: 100%;
            max-width: 900px;
            background: var(--card);
            border: 2px solid var(--border);
            border-radius: 20px;
            padding: 45px;
            position: relative;
            max-height: 95vh;
            overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }

        .close-btn {
            position: absolute;
            top: 25px;
            right: 25px;
            font-size: 36px;
            cursor: pointer;
            color: var(--muted);
            line-height: 1;
            transition: color 0.2s;
        }

        .close-btn:hover {
            color: var(--pink);
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 12px;
            font-size: 14px;
            font-weight: 800;
            color: var(--text);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .modal-select {
            width: 100%;
            background: #1c2128;
            border: 2px solid var(--pink);
            border-radius: 12px;
            color: #fff;
            padding: 18px;
            font-size: 22px;
            font-weight: bold;
            outline: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 20px center;
            background-size: 20px;
        }

        .modal-input,
        .modal-textarea {
            width: 100%;
            background: #1c2128;
            border: 2px solid var(--border);
            border-radius: 12px;
            color: #fff;
            padding: 18px;
            font-size: 20px;
            outline: none;
            transition: border-color 0.2s;
        }

        .modal-input:focus,
        .modal-textarea:focus {
            border-color: var(--pink);
            box-shadow: 0 0 10px rgba(248, 82, 173, 0.2);
        }

        .modal-textarea {
            height: 350px;
            font-family: monospace;
            font-size: 16px;
            line-height: 1.5;
        }

        .submit-btn {
            background: var(--pink);
            color: #000;
            font-weight: 900;
            border: none;
            padding: 22px;
            border-radius: 12px;
            width: 100%;
            cursor: pointer;
            text-transform: uppercase;
            font-size: 20px;
            letter-spacing: 1px;
            transition: transform 0.1s, opacity 0.2s;
        }

        .submit-btn:active {
            transform: scale(0.98);
        }

        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>

<body>

    <header>
        <div class="header-left">
            <h1>Rankings Suite</h1>
            <div class="selector-group">
                <div class="selector-wrapper">
                    <label>Franchise</label>
                    <select id="view-franchise" onchange="changeFranchiseView()">
                        <option value="liella">Liella</option>
                        <option value="aqours">Aqours</option>
                        <option value="u's">u's</option>
                        <option value="nijigasaki">Nijigasaki</option>
                        <option value="hasunosora">Hasunosora</option>
                    </select>
                </div>
                <div class="selector-wrapper">
                    <label>View</label>
                    <select id="view-subgroup" onchange="changeSubgroupView()"></select>
                </div>
            </div>
        </div>
        <div class="nav">
            <div class="nav-item active" id="btn-dash" onclick="tab('dash')">Dashboard</div>
            <div class="nav-item" id="btn-leader" onclick="tab('leader')">Rankings</div>
            <div class="nav-item" id="btn-more" onclick="tab('more')">Analysis</div>
            <div class="nav-item" id="btn-opps" onclick="tab('opps')">Divergence</div>
            <div class="nav-item" id="btn-rivals" onclick="tab('rivals')">Rivals</div>
            <div class="nav-item" id="btn-spice" onclick="tab('spice')">Spice</div>
            <div class="nav-item" onclick="window.location.href='users.html'">Users</div>
        </div>
    </header>

    <main>
        <!-- DASHBOARD VIEW -->
        <div id="view-dash" class="grid">
            <div class="dashboard-grid" id="dashboard-stats">
                <div class="stat-card">
                    <div class="stat-label">üëë Current #1</div>
                    <div class="stat-value" id="d-top-song">Loading...</div>
                    <div class="stat-sub" id="d-top-score">-- avg rank</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üî• Most Controversial</div>
                    <div class="stat-value" id="d-cont-song">Loading...</div>
                    <div class="stat-sub" id="d-cont-score">High Disagreement</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üå∂Ô∏è Spiciest User</div>
                    <div class="stat-value" id="d-spice-user">Loading...</div>
                    <div class="stat-sub" id="d-spice-val">-- Spice</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üò¥ Sleeper Hit</div>
                    <div class="stat-value" id="d-sleep-song">Loading...</div>
                    <div class="stat-sub" id="d-sleep-user">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ü§ù Most Agreed</div>
                    <div class="stat-value" id="d-agreed-song">Loading...</div>
                    <div class="stat-sub" id="d-agreed-score">Low Controversy</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üìä Total Songs</div>
                    <div class="stat-value" id="d-total-songs">--</div>
                    <div class="stat-sub">In current view</div>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="card">
                    <h3>üèÜ Top 5 Songs</h3>
                    <div class="table-container" id="c-dash-top5"></div>
                </div>
                <div class="card">
                    <h3>üìâ Bottom 5 Songs</h3>
                    <div class="table-container" id="c-dash-bottom5"></div>
                </div>
            </div>
        </div>

        <!-- FULL RANKINGS VIEW -->
        <div id="view-leader" class="card hidden">
            <h3>Full Community Consensus</h3>
            <div class="table-container" id="c-leaderboard"></div>
        </div>

        <!-- ANALYSIS VIEW -->
        <div id="view-more" class="grid hidden">
            <div class="dashboard-grid">
                <div class="card">
                    <h3>Most Disputed</h3>
                    <div class="table-container" id="c-disputed"></div>
                </div>
                <div class="card">
                    <h3>Controversial Tracks</h3>
                    <div class="table-container" id="c-controversy"></div>
                </div>
            </div>

            <div class="card">
                <h3>Subunit Power Rankings</h3>
                <div class="table-container" id="c-subunits"></div>
            </div>

            <div class="dashboard-grid">
                <div class="card">
                    <h3>Sleeper Picks</h3>
                    <div class="table-container" id="c-sleeper"></div>
                </div>
                <div class="card">
                    <h3>Consistent Tracks</h3>
                    <div class="table-container" id="c-consistent"></div>
                </div>
            </div>

            <div class="card">
                <h3>Outliers</h3>
                <div class="table-container" id="c-outliers"></div>
            </div>
            <div class="card">
                <h3>Top/Bottom 10</h3>
                <div class="table-container" id="c-universal"></div>
            </div>
        </div>

        <!-- DIVERGENCE VIEW -->
        <div id="view-opps" class="card hidden">
            <h3>User Divergence Matrix</h3>
            <div id="matrix-scroll-wrapper">
                <div id="c-matrix"></div>
            </div>
        </div>

        <!-- SPICE VIEW -->
        <div id="view-spice" class="card hidden">
            <h3>Global Spice Breakdown</h3>
            <div id="c-spice"></div>
        </div>

        <!-- RIVALS VIEW -->
        <div id="view-rivals" class="card hidden">
            <h3 style="border:none; text-align:center; font-size:18px;">üë• Head-to-Head Duel</h3>

            <div class="selector-group"
                style="margin-bottom:30px; justify-content:center; align-items:center; gap:20px;">
                <select id="duel-user-a" onchange="runDuel()"
                    style="width:200px; padding:12px; font-size:16px; background:var(--card); border:2px solid var(--border);"></select>
                <div style="font-weight:900; color:var(--red); font-size:24px; font-style:italic;">VS</div>
                <select id="duel-user-b" onchange="runDuel()"
                    style="width:200px; padding:12px; font-size:16px; background:var(--card); border:2px solid var(--border);"></select>
            </div>

            <div id="duel-results" class="hidden">
                <div style="text-align:center; margin-bottom:40px;">
                    <div
                        style="font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:2px; font-weight:700; margin-bottom:10px;">
                        Compatibility Score</div>
                    <div id="duel-score"
                        style="font-size:56px; line-height:1; font-weight:900; color:#fff; text-shadow:0 0 30px rgba(219,97,162,0.3);">
                        --%</div>
                    <div id="duel-msg" style="color:var(--pink); font-size:14px; font-weight:600; margin-top:5px;">--
                    </div>
                </div>

                <div class="card" style="margin-bottom:20px; border-color:var(--red);">
                    <h3 style="color:var(--red); border-color:rgba(248,81,73,0.3);">‚öîÔ∏è Biggest Disagreements</h3>
                    <div class="table-container" id="duel-disputes"></div>
                </div>
            </div>

            <div style="margin-top:40px; padding-top:30px; border-top:1px solid var(--border); text-align:center;">
                <h3 style="border:none; margin-bottom:20px;">üíò Find Your Match</h3>
                <div style="display:flex; gap:10px; align-items:center; justify-content:center; margin-bottom:20px;">
                    <select id="match-finder-user" style="width:200px;"></select>
                    <button class="btn-footer btn-submit-action" onclick="findMatches()"
                        style="padding:10px 20px;">Analyze</button>
                </div>
                <div id="match-results" class="grid" style="grid-template-columns: 1fr 1fr; gap:20px; text-align:left;">
                </div>
            </div>

            <div style="margin-top:20px; padding-top:20px; border-top:1px solid var(--border); text-align:center;">
                <h3 style="border:none; margin-bottom:10px;">üíñ Oshi Detector</h3>
                <div style="font-size:12px; color:var(--muted); margin-bottom:15px;">Who do you <i>really</i> love the
                    most? (Based on average rank)</div>
                <div style="display:flex; gap:10px; align-items:center; justify-content:center; margin-bottom:15px;">
                    <select id="bias-user"
                        style="width:200px; padding:10px; background:var(--card); border:1px solid var(--border); color:#fff; border-radius:6px;"></select>
                    <button class="btn-footer btn-submit-action" onclick="analyzeBias()"
                        style="padding:10px 20px;">Detect</button>
                </div>
                <div id="bias-results" class="grid"
                    style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:15px;"></div>
            </div>

            <div style="margin-top:20px; padding-top:20px; border-top:1px solid var(--border); text-align:center;">
                <h3 style="border:none; margin-bottom:10px;">üåå Taste Constellation</h3>
                <div style="font-size:12px; color:var(--muted); margin-bottom:15px;">Visualizing community factions.
                    Closer nodes = Shared taste.</div>
                <canvas id="taste-canvas"
                    style="width:100%; height:400px; background: radial-gradient(circle at center, #1b2028 0%, #0d1117 100%); border-radius:12px; border:1px solid var(--border)"></canvas>
            </div>
        </div>
    </main>

    <!-- UPDATED SUBMISSION OVERLAY -->
    <div id="submission-overlay">
        <div class="modal-card">
            <span class="close-btn" onclick="toggleSubmission(false)">&times;</span>
            <h3 style="font-size: 24px; margin-bottom: 30px; border:none;">Rankings Submission</h3>

            <div class="form-group">
                <label>1. Select Franchise</label>
                <select id="sub-franchise" class="modal-select">
                    <option value="liella">Liella</option>
                    <option value="aqours">Aqours</option>
                    <option value="u's">u's</option>
                    <option value="nijigasaki">Nijigasaki</option>
                    <option value="hasunosora">Hasunosora</option>
                </select>
            </div>

            <div class="form-group">
                <label>2. Your Name</label>
                <input type="text" id="in-user" class="modal-input" placeholder="Username">
            </div>

            <div class="form-group">
                <label>3. Ranked List (Format: 1. Song - Artist)</label>
                <textarea id="in-list" class="modal-textarea"
                    placeholder="1. Starlight Prologue - Liella!&#10;2. Âßã„Åæ„Çä„ÅØÂêõ„ÅÆÁ©∫ - Liella!"></textarea>
            </div>

            <button class="submit-btn" id="submit-btn-real" onclick="postSubmission()">Post My Rankings</button>
            <div id="submit-log" style="margin-top:20px; font-size:16px;"></div>
        </div>
    </div>

    <footer>
        <div class="footer-left">
            <div id="engine-log">READY</div>
        </div>
        <div class="footer-right">
            <button class="btn-footer" onclick="recompute()">Recompute</button>
            <button class="btn-footer btn-submit-action" onclick="toggleSubmission(true)">Submit</button>
        </div>
    </footer>

    <script>
        const API = "http://localhost:8000/api/v1";
        let activeTab = 'dash', allSubgroups = [];

        // Data cache to prevent redundant API calls
        let dataCache = { key: '', ranks: null, cont: null, takes: null, spice: null, loaded: false };

        async function init() {
            await fetchMasterSubgroups();
            tab('dash'); // Force dashboard view logic on startup
        }

        async function fetchMasterSubgroups() {
            const franchises = ["liella", "aqours", "u's", "nijigasaki", "hasunosora"];
            const results = await Promise.all(franchises.map(f => fetch(`${API}/subgroups?franchise=${f}`).then(r => r.json()).catch(() => [])));
            allSubgroups = results.flat();
            updateSubgroupDropdown();
        }

        function updateSubgroupDropdown() {
            const f = document.getElementById('view-franchise').value, sel = document.getElementById("view-subgroup");
            const filtered = allSubgroups.filter(sg => sg.franchise === f);
            sel.innerHTML = filtered.map(s => `<option value="${s.name}">${s.name}</option>`).join("");
            if (filtered.some(s => s.name === "All Songs")) sel.value = "All Songs";
        }

        function changeFranchiseView() {
            dataCache = { key: '', ranks: null, cont: null, takes: null, spice: null, loaded: false }; // Clear cache
            wipeUI();
            updateSubgroupDropdown();
            syncData(true); // Force fetch
        }

        function changeSubgroupView() {
            dataCache = { key: '', ranks: null, cont: null, takes: null, spice: null, loaded: false }; // Clear cache
            wipeUI();
            syncData(true); // Force fetch
        }

        function wipeUI() {
            const ids = ['c-leaderboard', 'c-universal', 'c-disputed', 'c-subunits', 'c-controversy', 'c-sleeper', 'c-consistent', 'c-outliers', 'c-matrix', 'c-spice', 'c-dash-top5', 'c-dash-bottom5', 'duel-disputes', 'match-results'];
            ids.forEach(id => { const el = document.getElementById(id); if (el) el.innerHTML = "Refreshing..."; });
            ['d-top-song', 'd-cont-song', 'd-spice-user', 'd-sleep-song', 'd-agreed-song', 'd-total-songs'].forEach(id => document.getElementById(id).innerHTML = "...");
            document.getElementById('duel-results').classList.add('hidden');
        }

        function tab(name) {
            activeTab = name;
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById(`btn-${name}`).classList.add('active');
            document.querySelectorAll('main > div').forEach(v => v.classList.add('hidden'));
            document.getElementById(`view-${name}`).classList.remove('hidden');
            syncData(false); // Don't force, use cache if available
        }

        async function syncData(forceFetch = false) {
            const sub = document.getElementById('view-subgroup').value, f = document.getElementById('view-franchise').value;
            if (!sub) return;

            const cacheKey = `${f}|${sub}`;
            let ranks, cont, takes, spice;

            // Check if we have cached data for this franchise/subgroup
            if (!forceFetch && dataCache.loaded && dataCache.key === cacheKey) {
                // Use cached data
                ranks = dataCache.ranks;
                cont = dataCache.cont;
                takes = dataCache.takes;
                spice = dataCache.spice;
            } else {
                // Fetch fresh data
                try {
                    [ranks, cont, takes, spice] = await Promise.all([
                        fetch(`${API}/analysis/rankings?franchise=${f}&subgroup=${sub}`).then(r => r.ok ? r.json() : null),
                        fetch(`${API}/analysis/controversy?franchise=${f}&subgroup=${sub}`).then(r => r.ok ? r.json() : null),
                        fetch(`${API}/analysis/takes?franchise=${f}&subgroup=${sub}`).then(r => r.ok ? r.json() : null),
                        fetch(`${API}/analysis/spice?franchise=${f}`).then(r => r.ok ? r.json() : null)
                    ]);

                    // Store in cache
                    dataCache = { key: cacheKey, ranks, cont, takes, spice, loaded: true };
                } catch (e) {
                    console.error('Fetch error:', e);
                    return;
                }
            }

            if (!ranks || !ranks.rankings) return;

            // Always update Dashboard Stats (if available)
            updateDashboard(ranks.rankings, cont?.results, takes?.takes, spice?.results);

            // Always render full leaderboard data in background (so it's ready)
            renderLeaderboard(ranks.rankings);

            // Conditional rendering for active tabs to save DOM cycles
            if (activeTab === 'more') {
                renderUniversal(ranks.rankings, cont?.results || []); renderDisputed(takes?.takes || []);
                renderSubunitPopularity(ranks.rankings, cont?.results || [], f); renderControversy(cont?.results || []);
                renderConsistent(cont?.results || []); renderSleepers(takes?.takes || []); renderOutliers(spice?.results || []);
            }
            if (activeTab === 'opps') renderMatrix(sub, f);
            if (activeTab === 'spice') renderSpice(spice?.results || []);
            if (activeTab === 'rivals') fetchUserList();
        }

        function updateDashboard(ranks, cont, takes, spice) {
            // 1. Top Song
            if (ranks.length > 0) {
                const top = ranks[0];
                document.getElementById('d-top-song').innerHTML = truncate(top.song_name, 22);
                document.getElementById('d-top-score').innerHTML = `${top.average} avg rank`;

                // Total songs count
                document.getElementById('d-total-songs').innerHTML = ranks.length;

                // Render Top 5 and Bottom 5
                renderDashTop5(ranks.slice(0, 5));
                renderDashBottom5(ranks.slice(-5).reverse());
            }

            // 2. Controversial
            if (cont && cont.length > 0) {
                const c = cont[0];
                document.getElementById('d-cont-song').innerHTML = truncate(c.song_name, 22);
                document.getElementById('d-cont-score').innerHTML = `${c.controversy_score} score`;

                // Most Agreed (lowest controversy)
                const agreed = [...cont].sort((a, b) => a.controversy_score - b.controversy_score)[0];
                if (agreed) {
                    document.getElementById('d-agreed-song').innerHTML = truncate(agreed.song_name, 22);
                    document.getElementById('d-agreed-score').innerHTML = `${agreed.controversy_score} score`;
                }
            }

            // 3. Spiciest User
            if (spice && spice.length > 0) {
                const s = spice[0];
                document.getElementById('d-spice-user').innerHTML = s.username;
                document.getElementById('d-spice-val').innerHTML = `${s.global_spice} spice`;
            }

            // 4. Sleeper Hit
            if (takes && takes.length > 0) {
                const sleeper = [...takes].sort((a, b) => a.score - b.score)[0];
                if (sleeper && sleeper.score < 0) {
                    document.getElementById('d-sleep-song').innerHTML = truncate(sleeper.song_name, 22);
                    document.getElementById('d-sleep-user').innerHTML = `Loved by ${sleeper.username}`;
                }
            }
        }

        function truncate(str, len) {
            return str.length > len ? str.substring(0, len) + '‚Ä¶' : str;
        }

        function renderDashTop5(ranks) {
            const el = document.getElementById('c-dash-top5');
            if (!el) return;
            el.innerHTML = `<table>` +
                ranks.map((s, i) => `
                    <tr>
                        <td class="col-rank" style="color:${i === 0 ? '#ffd700' : i === 1 ? '#c0c0c0' : i === 2 ? '#cd7f32' : 'var(--pink)'}">#${i + 1}</td>
                        <td>${s.song_name}</td>
                        <td class="col-metric" style="color:var(--green)">${s.average}</td>
                    </tr>
                `).join('') + `</table>`;
        }

        function renderDashBottom5(ranks) {
            const el = document.getElementById('c-dash-bottom5');
            if (!el) return;
            const total = parseInt(document.getElementById('d-total-songs')?.innerHTML) || 100;
            el.innerHTML = `<table>` +
                ranks.map((s, i) => `
                    <tr>
                        <td class="col-rank" style="color:var(--red)">#${total - i}</td>
                        <td>${s.song_name}</td>
                        <td class="col-metric" style="color:var(--red)">${s.average}</td>
                    </tr>
                `).join('') + `</table>`;
        }


        function renderLeaderboard(ranks) {
            document.getElementById('c-leaderboard').innerHTML = `<table><colgroup><col class="col-rank"><col><col class="col-metric"><col class="col-metric"></colgroup><tr><th>#</th><th>Song Name</th><th>Avg</th><th>Pts</th></tr>` +
                ranks.map((s, i) => `<tr><td class="col-rank">${i + 1}</td><td>${s.song_name}</td><td class="col-metric" style="color:var(--pink)">${s.average}</td><td class="col-metric">${s.points}</td></tr>`).join('') + `</table>`;
        }

        function renderUniversal(ranks, controversy) {
            const top = ranks.slice(0, 10), btm = ranks.slice(-10);
            const mapAgreement = (songName) => {
                const c = controversy.find(x => x.song_name === songName);
                return c ? Math.max(0, 100 - ((c.cv * c.avg_rank) * 2.5)).toFixed(1) : "0.0";
            };
            const rows = [...top, ...btm].map((s, i) => `<tr><td class="col-rank" style="color:${i < 10 ? 'var(--green)' : 'var(--red)'}">${i < 10 ? 'TOP' : 'BTM'}</td><td>${s.song_name}</td><td class="col-metric" style="color:var(--pink)">${s.average}</td><td class="col-metric">${mapAgreement(s.song_name)}%</td></tr>`).join('');
            document.getElementById('c-universal').innerHTML = `<table><colgroup><col class="col-rank"><col><col class="col-metric"><col class="col-metric"></colgroup><tr><th>Type</th><th>Song</th><th>Avg</th><th>Agr</th></tr>${rows}</table>`;
        }

        function renderDisputed(takes) {
            const songGroups = {};
            takes.forEach(t => { if (!songGroups[t.song_name]) songGroups[t.song_name] = []; songGroups[t.song_name].push(t); });
            const res = Object.keys(songGroups).map(name => {
                const g = songGroups[name].sort((a, b) => a.user_rank - b.user_rank);
                return { name, fight: `${g[0].username} vs ${g[g.length - 1].username}`, diff: Math.abs(g[g.length - 1].user_rank - g[0].user_rank) };
            }).sort((a, b) => b.diff - a.diff).slice(0, 10);
            document.getElementById('c-disputed').innerHTML = `<table><colgroup><col><col class="col-fight"><col class="col-metric"></colgroup><tr><th>Song</th><th>Fight</th><th class="col-metric">Diff</th></tr>` + res.map(r => `<tr><td>${r.name}</td><td class="col-fight">${r.fight}</td><td class="col-metric" style="color:var(--pink)">${r.diff}</td></tr>`).join('') + `</table>`;
        }

        function renderSubunitPopularity(rankings, controversy, franchise) {
            const subunits = allSubgroups.filter(sg => sg.franchise === franchise && sg.is_subunit);
            if (!subunits.length) { document.getElementById('c-subunits').innerHTML = "No subunits."; return; }
            const data = subunits.map(unit => {
                const rS = rankings.filter(r => unit.songs.includes(r.song_name)), cS = controversy.filter(r => unit.songs.includes(r.song_name));
                return { name: unit.name, avg: rS.length ? (rS.reduce((a, b) => a + b.average, 0) / rS.length).toFixed(2) : 0, div: cS.length ? (cS.reduce((a, b) => a + b.cv, 0) / cS.length).toFixed(4) : 0 };
            }).sort((a, b) => a.avg - b.avg);
            document.getElementById('c-subunits').innerHTML = `<table><colgroup><col><col class="col-metric"><col class="col-metric"></colgroup><tr><th>Unit</th><th class="col-metric">Avg</th><th class="col-metric">Div</th></tr>` + data.map(d => `<tr><td style="font-weight:bold">${d.name}</td><td class="col-metric" style="color:var(--pink)">${d.avg}</td><td class="col-metric">${d.div}</td></tr>`).join('') + `</table>`;
        }

        function renderControversy(results) { document.getElementById('c-controversy').innerHTML = `<table><colgroup><col><col class="col-metric"><col class="col-metric"></colgroup><tr><th>Song</th><th class="col-metric">Score</th><th class="col-metric">Div</th></tr>` + results.slice(0, 10).map(s => `<tr><td>${s.song_name}</td><td class="col-metric" style="color:var(--pink)">${s.controversy_score}</td><td class="col-metric">${s.cv}</td></tr>`).join('') + `</table>`; }
        function renderConsistent(results) { const sorted = [...results].sort((a, b) => a.controversy_score - b.controversy_score).slice(0, 10); document.getElementById('c-consistent').innerHTML = `<table><colgroup><col><col class="col-metric"><col class="col-metric"></colgroup><tr><th>Song</th><th class="col-metric">Score</th><th class="col-metric">Avg</th></tr>` + sorted.map(s => `<tr><td>${s.song_name}</td><td class="col-metric" style="color:var(--pink)">${s.controversy_score}</td><td class="col-metric">${s.avg_rank}</td></tr>`).join('') + `</table>`; }
        function renderSleepers(takes) { const sleepers = takes.filter(t => t.score < -15).slice(0, 10); document.getElementById('c-sleeper').innerHTML = `<table><colgroup><col><col class="col-metric"><col class="col-metric"></colgroup><tr><th>Song</th><th class="col-metric">Lover</th><th class="col-metric">Gap</th></tr>` + sleepers.map(t => `<tr><td>${t.song_name}</td><td class="col-metric">${t.username.substring(0, 8)}</td><td class="col-metric" style="color:var(--green)">${Math.abs(t.delta).toFixed(1)}</td></tr>`).join('') + `</table>`; }
        function renderOutliers(results) { if (!results || !results.length) return; const s = results.map(u => u.global_spice), min = Math.min(...s), max = Math.max(...s), r = (max - min) || 1; document.getElementById('c-outliers').innerHTML = `<table><colgroup><col><col class="col-metric"></colgroup><tr><th>User</th><th class="col-metric">Spice</th></tr>` + results.slice(0, 10).map(u => `<tr><td style="font-weight:bold">${u.username}</td><td class="metric"><div class="bar-bg" style="width:180px"><div class="bar-fill" style="width:${((u.global_spice - min) / r) * 100}%"></div><div style="font-size:10px; margin-top:-14px; margin-left:5px;">${u.global_spice}</div></div></td></tr>`).join('') + `</table>`; }

        async function renderMatrix(sub, f) {
            const wrap = document.getElementById("c-matrix"); wrap.innerHTML = "Loading...";
            try {
                const r = await fetch(`${API}/analysis/divergence?franchise=${f}&subgroup=${sub}`);
                const d = await r.json(), u = Object.keys(d.matrix).sort(), max = Math.max(...Object.values(d.matrix).flatMap(o => Object.values(o))) || 1;
                wrap.style.gridTemplateColumns = `150px repeat(${u.length}, 1fr)`;
                wrap.innerHTML = `<div></div>` + u.map(n => `<div class="m-label">${n}</div>`).join('');
                u.forEach(u1 => { wrap.innerHTML += `<div class="m-label" style="text-align:left">${u1}</div>`; u.forEach(u2 => { const v = d.matrix[u1][u2], op = Math.pow(v / max, 1.8); wrap.innerHTML += `<div class="cell" style="background:rgba(219, 97, 162, ${op}); color:${op > 0.5 ? '#fff' : '#8b949e'}; border-bottom:1px solid #0d1117;">${v}</div>`; }); });
            } catch (e) { wrap.innerHTML = "Error."; }
        }

        /* --- RIVALS LOGIC --- */
        let allUsers = [];

        async function fetchUserList() {
            const f = document.getElementById('view-franchise').value, sub = document.getElementById('view-subgroup').value;
            try {
                // Use divergence endpoint to get reliable user list
                const r = await fetch(`${API}/analysis/divergence?franchise=${f}&subgroup=${sub}`);
                const d = await r.json();
                allUsers = Object.keys(d.matrix).sort();
                // Init Graph
                setTimeout(() => typeof initConstellation === 'function' && initConstellation(d.matrix), 500);

                const opts = allUsers.map(u => `<option value="${u}">${u}</option>`).join('');
                ['duel-user-a', 'duel-user-b', 'match-finder-user', 'bias-user'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el && !el.innerHTML) {  // Only populate if empty to preserve selection
                        const old = el.value;
                        el.innerHTML = '<option value="">Select User</option>' + opts;
                        if (old && allUsers.includes(old)) el.value = old;
                    } else if (el && el.innerHTML === "") {
                        el.innerHTML = '<option value="">Select User</option>' + opts;
                    }
                });
            } catch (e) { }
        }

        async function runDuel() {
            const u1 = document.getElementById('duel-user-a').value;
            const u2 = document.getElementById('duel-user-b').value;
            if (!u1 || !u2 || u1 === u2) {
                document.getElementById('duel-results').classList.add('hidden');
                return;
            }

            const f = document.getElementById('view-franchise').value, sub = document.getElementById('view-subgroup').value;
            document.getElementById('duel-score').innerHTML = "...";
            document.getElementById('duel-results').classList.remove('hidden');

            try {
                const res = await fetch(`${API}/analysis/head-to-head?franchise=${f}&subgroup=${sub}&user_a=${u1}&user_b=${u2}`);
                const data = await res.json();

                // Render Score
                const sc = data.score;
                document.getElementById('duel-score').innerHTML = `${sc}%`;
                document.getElementById('duel-score').style.color = sc > 75 ? 'var(--green)' : sc < 40 ? 'var(--red)' : '#fff';
                document.getElementById('duel-msg').innerHTML = sc > 85 ? "BEST FRIENDS FOREVER üíñ" : sc > 60 ? "Solid Compatibility üëç" : sc < 30 ? "MORTAL ENEMIES üíÄ" : "It's Complicated ü§∑";

                // Render Disputes
                const disputes = data.diffs.slice(0, 10);
                document.getElementById('duel-disputes').innerHTML = `<table>
                    <colgroup><col><col style="width:80px"><col style="width:80px"><col style="width:60px"></colgroup>
                    <tr><th>Song</th><th>${u1}</th><th>${u2}</th><th>Diff</th></tr>` +
                    disputes.map(d => `
                        <tr>
                            <td>${d.name}</td>
                            <td style="color:${d.r1 < d.r2 ? 'var(--green)' : 'var(--muted)'}">#${d.r1}</td>
                            <td style="color:${d.r2 < d.r1 ? 'var(--green)' : 'var(--muted)'}">#${d.r2}</td>
                            <td style="font-weight:bold; color:var(--red)">${Math.round(d.diff)}</td>
                        </tr>`).join('') + `</table>`;

            } catch (e) { console.error(e); document.getElementById('duel-score').innerHTML = "Err"; }
        }

        async function findMatches() {
            const u = document.getElementById('match-finder-user').value;
            if (!u) return;
            const f = document.getElementById('view-franchise').value, sub = document.getElementById('view-subgroup').value;
            const res = document.getElementById('match-results');
            res.innerHTML = "Scanning database...";

            try {
                const r = await fetch(`${API}/analysis/user-match?franchise=${f}&subgroup=${sub}&user=${u}`);
                const data = await r.json();

                const renderCard = (title, list, color) => `
                    <div class="card" style="border-color:${color}">
                        <h3 style="color:${color}; border-color:${color}; margin-bottom:10px;">${title}</h3>
                        ${list.map(x => `<div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid rgba(255,255,255,0.05)">
                            <span style="font-weight:600">${x.user}</span>
                            <span style="font-family:Consolas; opacity:0.7">Div: ${x.div.toFixed(2)}</span>
                        </div>`).join('')}
                    </div>
                `;

                res.innerHTML = renderCard("‚ù§Ô∏è Soulmates", data.soulmates, "var(--green)") +
                    renderCard("üíÄ Nemeses", data.nemeses, "var(--red)");
            } catch (e) { res.innerHTML = "Error finding matches."; }
        }

        async function analyzeBias() {
            const u = document.getElementById('bias-user').value;
            if (!u) return;
            const f = document.getElementById('view-franchise').value;
            const res = document.getElementById('bias-results');
            res.innerHTML = "Computing bias...";

            try {
                const r = await fetch(`${API}/analysis/oshi-bias?franchise=${f}&user=${u}`);
                const d = await r.json();

                if (d.error) { res.innerHTML = d.error; return; }

                let html = '';
                d.biases.forEach((b, i) => {
                    html += `
                     <div class="stat-card" style="padding:15px; border-color:${i === 0 ? 'var(--pink)' : 'var(--border)'}">
                        <div style="font-size:10px; opacity:0.7; text-transform:uppercase; letter-spacing:1px;">${i === 0 ? 'üèÜ OSHI' : 'Favored Member'}</div>
                        <div style="font-size:16px; font-weight:bold; color:#fff; margin:5px 0;">${b.name}</div>
                        <div style="font-size:24px; font-weight:900; color:${i === 0 ? 'var(--pink)' : 'var(--green)'}">+${b.bias}</div>
                        <div style="font-size:11px; opacity:0.5; margin-top:5px;">Avg Rank #${b.avg_rank} (${b.count} songs)</div>
                     </div>`;
                });
                res.innerHTML = html || "No significant bias found (You love everyone equally?).";
            } catch (e) { console.error(e); res.innerHTML = "Error."; }
        }



        /* --- CONSTELLATION GRAPH --- */
        let graphCtx = null, graphNodes = [], graphEdges = [], graphAnimParams = { w: 0, h: 0 };

        function initConstellation(matrix) {
            const cvs = document.getElementById('taste-canvas');
            if (!cvs || !matrix) return;
            // Resize logic
            const rect = cvs.getBoundingClientRect();
            cvs.width = rect.width; cvs.height = rect.height;
            graphCtx = cvs.getContext('2d');
            graphAnimParams.w = cvs.width; graphAnimParams.h = cvs.height;

            const users = Object.keys(matrix);
            // Initialize Nodes
            graphNodes = users.map(u => ({
                id: u,
                x: Math.random() * cvs.width,
                y: Math.random() * cvs.height,
                vx: 0, vy: 0,
                color: `hsl(${Math.random() * 360}, 70%, 60%)`
            }));

            // Initialize Edges (Connect if divergence < Threshold)
            // Calculate avg divergence to set threshold
            let sum = 0, count = 0;
            users.forEach(u1 => users.forEach(u2 => { if (u1 !== u2) { sum += matrix[u1][u2]; count++; } }));
            const avg = count ? sum / count : 20;
            const threshold = avg * 0.8; // Connect stronger than average pairs

            graphEdges = [];
            for (let i = 0; i < users.length; i++) {
                for (let j = i + 1; j < users.length; j++) {
                    const u1 = users[i], u2 = users[j];
                    const div = matrix[u1][u2];
                    if (div < threshold) {
                        graphEdges.push({ source: i, target: j, strength: 1 - (div / threshold) });
                    }
                }
            }

            requestAnimationFrame(updateGraph);
        }

        function updateGraph() {
            if (!graphCtx) return;
            const { w, h } = graphAnimParams;

            // Physics Step
            // Repulsion
            for (let i = 0; i < graphNodes.length; i++) {
                for (let j = i + 1; j < graphNodes.length; j++) {
                    const dx = graphNodes[i].x - graphNodes[j].x;
                    const dy = graphNodes[i].y - graphNodes[j].y;
                    const d2 = dx * dx + dy * dy + 0.1;
                    const dist = Math.sqrt(d2);
                    const force = 500 / d2;
                    const fx = (dx / dist) * force;
                    const fy = (dy / dist) * force;
                    graphNodes[i].vx += fx; graphNodes[i].vy += fy;
                    graphNodes[j].vx -= fx; graphNodes[j].vy -= fy;
                }
            }

            // Attraction
            graphEdges.forEach(e => {
                const n1 = graphNodes[e.source], n2 = graphNodes[e.target];
                const dx = n2.x - n1.x, dy = n2.y - n1.y;
                const dist = Math.sqrt(dx * dx + dy * dy);
                const force = (dist - 100) * 0.05 * e.strength; // Spring length 100
                const fx = (dx / dist) * force, fy = (dy / dist) * force;
                n1.vx += fx; n1.vy += fy;
                n2.vx -= fx; n2.vy -= fy;
            });

            // Center Gravity
            graphNodes.forEach(n => {
                n.vx += (w / 2 - n.x) * 0.01;
                n.vy += (h / 2 - n.y) * 0.01;
                // Damping
                n.vx *= 0.9; n.vy *= 0.9;
                n.x += n.vx; n.y += n.vy;

                // Bounds
                if (n.x < 10) n.x = 10; if (n.x > w - 10) n.x = w - 10;
                if (n.y < 10) n.y = 10; if (n.y > h - 10) n.y = h - 10;
            });

            // Draw
            graphCtx.clearRect(0, 0, w, h);

            // Edges
            graphCtx.lineWidth = 1;
            graphEdges.forEach(e => {
                const n1 = graphNodes[e.source], n2 = graphNodes[e.target];
                graphCtx.strokeStyle = `rgba(219, 97, 162, ${e.strength * 0.5})`;
                graphCtx.beginPath();
                graphCtx.moveTo(n1.x, n1.y);
                graphCtx.lineTo(n2.x, n2.y);
                graphCtx.stroke();
            });

            // Nodes
            graphNodes.forEach(n => {
                graphCtx.fillStyle = n.color;
                graphCtx.beginPath();
                graphCtx.arc(n.x, n.y, 6, 0, Math.PI * 2);
                graphCtx.fill();
                graphCtx.fillStyle = "#fff";
                graphCtx.font = "10px sans-serif";
                graphCtx.fillText(n.id, n.x + 8, n.y + 3);
            });

            requestAnimationFrame(updateGraph);
        }

        function renderSpice(results) {
            if (!results || !results.length) return;
            const s = results.map(u => u.global_spice), min = Math.min(...s), max = Math.max(...s), r = (max - min) || 1;
            document.getElementById('c-spice').innerHTML = results.map(u => {
                const norm = ((u.global_spice - min) / r) * 100;
                return `<div style="margin-bottom:30px;"><div style="display:flex; justify-content:space-between; font-size:24px;"><strong>${u.username}</strong><span class="metric">${u.global_spice}</span></div><div class="bar-bg" style="height:24px"><div class="bar-fill" style="width:${norm}%"></div></div></div>`;
            }).join('');
        }

        function toggleSubmission(show) { document.getElementById('submission-overlay').style.display = show ? 'flex' : 'none'; }

        // UPDATED SUBMISSION LOGIC
        async function postSubmission() {
            const log = document.getElementById('submit-log');
            const user = document.getElementById('in-user').value.trim();
            const list = document.getElementById('in-list').value.trim();
            const f = document.getElementById('sub-franchise').value;
            const btn = document.getElementById('submit-btn-real');

            // Validation: Ensure fields are non-empty
            if (!user || !list) {
                log.innerHTML = `<span style="color:var(--red)">Username and list are required.</span>`;
                return;
            }

            btn.disabled = true;
            log.innerHTML = "POSTING DATA...";

            try {
                const r = await fetch(`${API}/submit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: user,
                        franchise: f,
                        subgroup_name: "All Songs",
                        ranking_list: list
                    })
                });
                const d = await r.json();
                if (d.status === "VALID") {
                    log.innerHTML = `<span style="color:var(--green)">SUCCESSFULLY SUBMITTED!</span>`;
                    setTimeout(() => {
                        toggleSubmission(false);
                        btn.disabled = false;
                    }, 1500);
                } else {
                    let firstErr = Object.values(d.conflicts)[0];
                    log.innerHTML = `<span style="color:var(--red)">VALIDATION ERROR: Line ${firstErr.line_num} (${firstErr.reason})</span>`;
                    btn.disabled = false;
                }
            } catch (e) {
                log.innerHTML = `<span style="color:var(--red)">CONNECTION ERROR.</span>`;
                btn.disabled = false;
            }
        }

        async function recompute() {
            document.getElementById('engine-log').innerText = "CALCULATING...";
            await fetch(`${API}/analysis/trigger`, { method: 'POST' });
            setTimeout(() => { syncData(); document.getElementById('engine-log').innerText = "READY"; }, 3000);
        }

        init();
    </script>
</body>

</html>